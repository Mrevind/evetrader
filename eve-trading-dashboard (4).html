<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>EVE TRADE OPS ‚Äî Market Intelligence Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --void: #040810;
    --deep: #080f1a;
    --hull: #0d1826;
    --panel: #111f30;
    --border: #1a3a5c;
    --border-bright: #2a6090;
    --accent: #00c8ff;
    --accent2: #00ff9d;
    --accent3: #ff6b35;
    --warn: #ffbb00;
    --danger: #ff3355;
    --text: #c8e0f0;
    --text-dim: #5a7a95;
    --text-bright: #e8f4ff;
    --glow: rgba(0,200,255,0.15);
    --glow2: rgba(0,255,157,0.1);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--void);
    color: var(--text);
    font-family: 'Exo 2', sans-serif;
    font-size: 14px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,200,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,200,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* Scanline overlay */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.08) 2px,
      rgba(0,0,0,0.08) 4px
    );
    pointer-events: none;
    z-index: 1;
  }

  #app { position: relative; z-index: 2; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 24px;
    height: 56px;
    background: linear-gradient(180deg, rgba(0,200,255,0.08) 0%, transparent 100%);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(12px);
  }

  .logo {
    font-family: 'Rajdhani', sans-serif;
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 4px;
    color: var(--accent);
    text-shadow: 0 0 20px rgba(0,200,255,0.6);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-icon {
    width: 28px;
    height: 28px;
    border: 2px solid var(--accent);
    transform: rotate(45deg);
    position: relative;
    box-shadow: 0 0 12px rgba(0,200,255,0.4);
  }

  .logo-icon::after {
    content: '';
    position: absolute;
    inset: 4px;
    background: var(--accent);
    transform: rotate(0deg);
    opacity: 0.4;
  }

  .header-center {
    display: flex;
    gap: 2px;
  }

  .nav-tab {
    padding: 6px 18px;
    border: 1px solid transparent;
    background: none;
    color: var(--text-dim);
    font-family: 'Rajdhani', sans-serif;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
  }

  .nav-tab:hover { color: var(--accent); border-color: var(--border-bright); background: var(--glow); }
  .nav-tab.active { color: var(--accent); border-color: var(--accent); background: var(--glow); }

  .header-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .auth-btn {
    padding: 7px 20px;
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent);
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 12px;
    letter-spacing: 2px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.2s;
    clip-path: polygon(6px 0%, 100% 0%, calc(100% - 6px) 100%, 0% 100%);
  }

  .auth-btn:hover { background: var(--glow); box-shadow: 0 0 12px rgba(0,200,255,0.3); }
  .auth-btn.connected { border-color: var(--accent2); color: var(--accent2); }

  .pilot-badge {
    display: none;
    align-items: center;
    gap: 8px;
    padding: 4px 12px 4px 4px;
    border: 1px solid var(--border-bright);
    background: var(--hull);
  }

  .pilot-badge.show { display: flex; }

  .pilot-avatar {
    width: 32px;
    height: 32px;
    background: var(--panel);
    border: 1px solid var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .pilot-name { font-family: 'Rajdhani', sans-serif; font-weight: 600; font-size: 13px; color: var(--text-bright); }
  .pilot-corp { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--text-dim); }

  /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
  .dashboard { padding: 20px 24px; max-width: 1600px; margin: 0 auto; }

  /* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: var(--hull);
    border: 1px solid var(--border);
    padding: 16px 20px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--accent);
    box-shadow: 0 0 8px var(--accent);
  }

  .stat-card:nth-child(2)::before { background: var(--accent2); box-shadow: 0 0 8px var(--accent2); }
  .stat-card:nth-child(3)::before { background: var(--warn); box-shadow: 0 0 8px var(--warn); }
  .stat-card:nth-child(4)::before { background: var(--accent3); box-shadow: 0 0 8px var(--accent3); }

  .stat-card:hover { border-color: var(--border-bright); }

  .stat-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .stat-value {
    font-family: 'Rajdhani', sans-serif;
    font-size: 28px;
    font-weight: 700;
    color: var(--text-bright);
    line-height: 1;
  }

  .stat-sub {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 4px;
    font-family: 'Share Tech Mono', monospace;
  }

  .stat-up { color: var(--accent2); }
  .stat-down { color: var(--danger); }

  .stat-corner {
    position: absolute;
    right: 14px;
    top: 14px;
    font-size: 22px;
    opacity: 0.12;
  }

  /* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
  .panel-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
  }

  .panel-row.triple { grid-template-columns: 2fr 1fr 1fr; }
  .panel-row.full { grid-template-columns: 1fr; }

  .panel {
    background: var(--hull);
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--deep);
  }

  .panel-title {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 13px;
    letter-spacing: 3px;
    color: var(--accent);
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .panel-title::before {
    content: '';
    width: 8px;
    height: 8px;
    background: var(--accent);
    transform: rotate(45deg);
    box-shadow: 0 0 6px var(--accent);
    flex-shrink: 0;
  }

  .panel-body { padding: 16px; }

  /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
  .data-table { width: 100%; border-collapse: collapse; }
  .data-table th {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 1.5px;
    text-align: left;
    padding: 6px 10px;
    border-bottom: 1px solid var(--border);
    text-transform: uppercase;
    white-space: nowrap;
  }

  .data-table td {
    padding: 9px 10px;
    border-bottom: 1px solid rgba(26,58,92,0.5);
    font-size: 13px;
    vertical-align: middle;
  }

  .data-table tr:hover td { background: rgba(0,200,255,0.04); }
  .data-table tr:last-child td { border-bottom: none; }

  .item-name { font-weight: 600; color: var(--text-bright); }
  .item-link { cursor: pointer; transition: color 0.15s; }
  .item-link:hover { color: var(--accent); text-decoration: underline; text-underline-offset: 3px; }
  .item-type { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--text-dim); }

  .isk { font-family: 'Share Tech Mono', monospace; color: var(--warn); }
  .isk-green { font-family: 'Share Tech Mono', monospace; color: var(--accent2); }
  .isk-red { font-family: 'Share Tech Mono', monospace; color: var(--danger); }

  .qty-badge {
    display: inline-block;
    background: var(--panel);
    border: 1px solid var(--border);
    padding: 1px 6px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--text);
  }

  .status-badge {
    display: inline-block;
    padding: 2px 8px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    letter-spacing: 1px;
  }

  .status-buy { background: rgba(0,200,255,0.1); border: 1px solid var(--accent); color: var(--accent); }
  .status-sell { background: rgba(255,107,53,0.1); border: 1px solid var(--accent3); color: var(--accent3); }
  .status-hold { background: rgba(255,187,0,0.1); border: 1px solid var(--warn); color: var(--warn); }

  .profit-bar-wrap { display: flex; align-items: center; gap: 8px; }
  .profit-bar {
    height: 4px;
    background: var(--border);
    flex: 1;
    max-width: 80px;
    position: relative;
    overflow: hidden;
  }

  .profit-bar-fill {
    height: 100%;
    background: var(--accent2);
    box-shadow: 0 0 6px var(--accent2);
  }

  /* ‚îÄ‚îÄ CHART ‚îÄ‚îÄ */
  .chart-wrap { position: relative; height: 220px; }
  .chart-wrap canvas { width: 100% !important; }

  /* ‚îÄ‚îÄ RECOMMENDATION ‚îÄ‚îÄ */
  .rec-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    border: 1px solid var(--border);
    margin-bottom: 8px;
    background: var(--deep);
    transition: border-color 0.2s;
    cursor: default;
  }

  .rec-item:hover { border-color: var(--border-bright); }

  .rec-signal {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
    border: 1px solid;
  }

  .rec-signal.sell { border-color: var(--accent2); color: var(--accent2); background: rgba(0,255,157,0.08); }
  .rec-signal.wait { border-color: var(--warn); color: var(--warn); background: rgba(255,187,0,0.08); }
  .rec-signal.buy { border-color: var(--accent); color: var(--accent); background: rgba(0,200,255,0.08); }

  .rec-info { flex: 1; }
  .rec-name { font-weight: 600; font-size: 13px; color: var(--text-bright); }
  .rec-detail { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--text-dim); margin-top: 2px; }
  .rec-profit { font-family: 'Rajdhani', sans-serif; font-size: 18px; font-weight: 700; }
  .rec-profit.pos { color: var(--accent2); }
  .rec-profit.neg { color: var(--danger); }

  /* ‚îÄ‚îÄ INVENTORY ‚îÄ‚îÄ */
  .inv-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 8px;
  }

  .inv-cell {
    background: var(--deep);
    border: 1px solid var(--border);
    padding: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }

  .inv-cell:hover { border-color: var(--accent); box-shadow: 0 0 10px rgba(0,200,255,0.15); }

  .inv-cell-icon { font-size: 24px; margin-bottom: 4px; }
  .inv-cell-name { font-size: 11px; color: var(--text-bright); font-weight: 600; line-height: 1.2; margin-bottom: 2px; }
  .inv-cell-qty { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--text-dim); }
  .inv-cell-val { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--warn); margin-top: 2px; }

  /* ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ */
  .input-row { display: flex; gap: 8px; margin-bottom: 16px; }

  .esi-input {
    flex: 1;
    background: var(--deep);
    border: 1px solid var(--border);
    color: var(--text-bright);
    padding: 8px 12px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    outline: none;
    transition: border-color 0.2s;
  }

  .esi-input:focus { border-color: var(--accent); box-shadow: 0 0 8px rgba(0,200,255,0.2); }
  .esi-input::placeholder { color: var(--text-dim); }

  .esi-btn {
    padding: 8px 16px;
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent);
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 12px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .esi-btn:hover { background: var(--glow); box-shadow: 0 0 10px rgba(0,200,255,0.3); }
  .esi-btn.green { border-color: var(--accent2); color: var(--accent2); }
  .esi-btn.green:hover { background: var(--glow2); }

  /* ‚îÄ‚îÄ WALLET CHART ‚îÄ‚îÄ */
  .wallet-time { display: flex; gap: 6px; margin-bottom: 10px; }
  .time-btn {
    padding: 3px 10px;
    background: none;
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .time-btn:hover, .time-btn.active { border-color: var(--accent); color: var(--accent); background: var(--glow); }

  /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
  .loading-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(4,8,16,0.85);
    z-index: 500;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
  }

  .loading-overlay.show { display: flex; }

  .loading-ring {
    width: 60px;
    height: 60px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text {
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    color: var(--accent);
    letter-spacing: 3px;
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

  /* ‚îÄ‚îÄ AUTH MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(4,8,16,0.9);
    z-index: 600;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.show { display: flex; }

  .modal {
    background: var(--hull);
    border: 1px solid var(--border-bright);
    padding: 32px;
    max-width: 480px;
    width: 90%;
    position: relative;
    box-shadow: 0 0 40px rgba(0,200,255,0.15);
  }

  .modal::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
  }

  .modal-title {
    font-family: 'Rajdhani', sans-serif;
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 4px;
    color: var(--accent);
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .modal-subtitle { color: var(--text-dim); font-size: 12px; margin-bottom: 24px; line-height: 1.6; }

  .modal-section { margin-bottom: 20px; }
  .modal-section-title {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border);
  }

  .scope-list { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
  .scope-tag {
    padding: 2px 8px;
    background: var(--panel);
    border: 1px solid var(--border);
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
  }

  .sso-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
    padding: 12px;
    background: var(--deep);
    border: 2px solid var(--accent);
    color: var(--accent);
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 14px;
    letter-spacing: 3px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 10px;
  }

  .sso-btn:hover { background: var(--glow); box-shadow: 0 0 20px rgba(0,200,255,0.3); }

  .demo-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
    padding: 10px;
    background: transparent;
    border: 1px solid var(--border-bright);
    color: var(--text-dim);
    font-family: 'Rajdhani', sans-serif;
    font-weight: 600;
    font-size: 13px;
    letter-spacing: 2px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
  }

  .demo-btn:hover { color: var(--text); border-color: var(--accent2); background: var(--glow2); }

  .modal-close {
    position: absolute;
    top: 12px;
    right: 16px;
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 18px;
    cursor: pointer;
  }

  .modal-close:hover { color: var(--text); }

  /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
  .footer {
    text-align: center;
    padding: 20px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    border-top: 1px solid var(--border);
    margin-top: 20px;
    letter-spacing: 2px;
  }

  /* ‚îÄ‚îÄ MARKET LOOKUP ‚îÄ‚îÄ */
  .lookup-result {
    background: var(--deep);
    border: 1px solid var(--border);
    padding: 14px;
    margin-top: 10px;
    display: none;
  }

  .lookup-result.show { display: block; }
  .lookup-name { font-family: 'Rajdhani', sans-serif; font-size: 18px; font-weight: 700; color: var(--text-bright); margin-bottom: 8px; }
  .lookup-prices { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
  .lookup-price-item { text-align: center; }
  .lookup-price-label { font-family: 'Share Tech Mono', monospace; font-size: 9px; color: var(--text-dim); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 2px; }
  .lookup-price-val { font-family: 'Rajdhani', sans-serif; font-size: 16px; font-weight: 700; }

  /* ‚îÄ‚îÄ ADD TRADE FORM ‚îÄ‚îÄ */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .form-group { display: flex; flex-direction: column; gap: 4px; }
  .form-label { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--text-dim); letter-spacing: 1px; text-transform: uppercase; }

  select.esi-input { -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%235a7a95'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; }

  .setup-step { animation: fadeInUp 0.25s ease both; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--deep); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 0; }
  ::-webkit-scrollbar-thumb:hover { background: var(--border-bright); }

  /* Responsive */
  @media (max-width: 900px) {
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .panel-row { grid-template-columns: 1fr; }
    .panel-row.triple { grid-template-columns: 1fr; }
    header { padding: 0 12px; }
    .header-center { display: none; }
    .dashboard { padding: 12px; }
  }

  /* Tab views */
  .tab-view { display: none; }
  .tab-view.active { display: block; }

  /* Animated entry */
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .panel, .stat-card {
    animation: fadeInUp 0.4s ease both;
  }

  .stat-card:nth-child(1) { animation-delay: 0.05s; }
  .stat-card:nth-child(2) { animation-delay: 0.1s; }
  .stat-card:nth-child(3) { animation-delay: 0.15s; }
  .stat-card:nth-child(4) { animation-delay: 0.2s; }

  .ticker {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .ticker-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--accent2);
    box-shadow: 0 0 6px var(--accent2);
    animation: pulse 2s infinite;
  }

  .no-data {
    text-align: center;
    padding: 40px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    color: var(--text-dim);
    letter-spacing: 2px;
  }

  .no-data .lock-icon { font-size: 32px; margin-bottom: 10px; opacity: 0.4; }
</style>
</head>
<body>
<div id="app">

<!-- Loading -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-ring"></div>
  <div class="loading-text">SYNCING WITH ESI SERVERS...</div>
</div>

<!-- Auth Modal -->
<div class="modal-overlay" id="authModal">
  <div class="modal" style="max-width:540px">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div class="modal-title">Connect Pilot</div>
    <div class="modal-subtitle">Uses EVE SSO with PKCE ‚Äî no backend required. Works as a static website.</div>

    <!-- Step tabs -->
    <div style="display:flex;gap:2px;margin-bottom:18px" id="setupTabs">
      <button class="nav-tab active" style="flex:1;clip-path:none;font-size:11px" onclick="showStep(1,this)">1 ¬∑ REGISTER APP</button>
      <button class="nav-tab" style="flex:1;clip-path:none;font-size:11px" onclick="showStep(2,this)">2 ¬∑ CONFIGURE</button>
      <button class="nav-tab" style="flex:1;clip-path:none;font-size:11px" onclick="showStep(3,this)">3 ¬∑ CONNECT</button>
    </div>

    <!-- Step 1: Register -->
    <div id="step1" class="setup-step">
      <div class="modal-section-title" style="margin-bottom:10px">CREATE YOUR EVE DEVELOPER APP</div>
      <ol style="padding-left:18px;line-height:2;font-size:12px;color:var(--text)">
        <li>Go to <a href="https://developers.eveonline.com" target="_blank" style="color:var(--accent)">developers.eveonline.com</a> and log in</li>
        <li>Click <strong style="color:var(--text-bright)">Create New Application</strong></li>
        <li>Set <strong style="color:var(--text-bright)">Connection Type</strong> to <span class="scope-tag">Authentication & API Access</span></li>
        <li>Add these <strong style="color:var(--text-bright)">Scopes</strong>:</li>
      </ol>
      <div class="scope-list" style="margin:8px 0 12px 18px">
        <span class="scope-tag">esi-wallet.read_character_wallet.v1</span>
        <span class="scope-tag">esi-markets.read_character_orders.v1</span>
        <span class="scope-tag">esi-assets.read_assets.v1</span>
      </div>
      <ol start="5" style="padding-left:18px;line-height:2;font-size:12px;color:var(--text)">
        <li>Set <strong style="color:var(--text-bright)">Callback URL</strong> to the URL of this page:<br/>
          <span id="thisUrl" style="font-family:Share Tech Mono,monospace;font-size:10px;color:var(--accent);word-break:break-all">https://mrevind.github.io/evetrader/</span>
        </li>
        <li>Save ‚Äî copy your <strong style="color:var(--text-bright)">Client ID</strong></li>
      </ol>
      <button class="esi-btn" style="margin-top:12px;width:100%" onclick="showStep(2,document.querySelectorAll('#setupTabs .nav-tab')[1])">NEXT ‚Üí</button>
    </div>

    <!-- Step 2: Configure -->
    <div id="step2" class="setup-step" style="display:none">
      <div class="modal-section-title" style="margin-bottom:10px">ENTER YOUR CLIENT ID</div>
      <div class="form-group" style="margin-bottom:16px">
        <div class="form-label">Client ID</div>
        <input type="text" class="esi-input" id="clientIdInput" placeholder="paste your Client ID here..." />
      </div>
      <div style="font-family:Share Tech Mono,monospace;font-size:10px;color:var(--text-dim);line-height:1.8;margin-bottom:16px">
        ‚Ñπ PKCE flow ‚Äî no Client Secret needed.<br/>
        Your token is stored only in this browser's localStorage.<br/>
        Never shared with any third party.
      </div>
      <button class="esi-btn green" style="width:100%" onclick="saveClientId()">SAVE & CONTINUE ‚Üí</button>
    </div>

    <!-- Step 3: Connect -->
    <div id="step3" class="setup-step" style="display:none">
      <div class="modal-section-title" style="margin-bottom:10px">AUTHENTICATE PILOT</div>
      <div id="savedClientDisplay" style="font-family:Share Tech Mono,monospace;font-size:11px;color:var(--text-dim);margin-bottom:14px;padding:8px;background:var(--deep);border:1px solid var(--border)">
        CLIENT ID: <span id="savedClientId" style="color:var(--accent)">‚Äî</span>
      </div>
      <button class="sso-btn" onclick="launchPKCE()">
        <span>‚ö°</span>
        <span>AUTHENTICATE WITH EVE SSO</span>
      </button>
      <div style="text-align:center;font-family:Share Tech Mono,monospace;font-size:10px;color:var(--text-dim);margin:10px 0">‚Äî OR ‚Äî</div>
      <button class="demo-btn" onclick="loadDemoData()">LOAD DEMO DATA (NO LOGIN REQUIRED)</button>
    </div>

  </div>
</div>

<!-- Header -->
<header>
  <div class="logo">
    <div class="logo-icon"></div>
    EVE TRADE OPS
  </div>

  <div class="header-center">
    <button class="nav-tab active" onclick="switchTab('overview', this)">OVERVIEW</button>
    <button class="nav-tab" onclick="switchTab('transactions', this)">TRANSACTIONS</button>
    <button class="nav-tab" onclick="switchTab('orders', this)">ORDERS</button>
    <button class="nav-tab" onclick="switchTab('inventory', this)">INVENTORY</button>
    <button class="nav-tab" onclick="switchTab('lookup', this)">MARKET</button>
    <button class="nav-tab" onclick="switchTab('jita', this)">JITA TRACKER</button>
  </div>

  <div class="header-right">
    <div class="ticker">
      <div class="ticker-dot"></div>
      <span id="ticker">ESI LIVE</span>
    </div>
    <div class="pilot-badge" id="pilotBadge">
      <div class="pilot-avatar">üë§</div>
      <div>
        <div class="pilot-name" id="pilotName">‚Äî</div>
        <div class="pilot-corp" id="pilotCorp">‚Äî</div>
      </div>
    </div>
    <button class="auth-btn" id="refreshBtn" onclick="manualRefresh()" style="display:none;border-color:var(--accent2);color:var(--accent2)" title="Refresh data from ESI">‚Üª REFRESH</button>
    <button class="auth-btn" id="connectBtn" onclick="openModal()">CONNECT PILOT</button>
  </div>
</header>

<div class="dashboard">

  <!-- OVERVIEW TAB -->
  <div class="tab-view active" id="tab-overview">

    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-corner">üí∞</div>
        <div class="stat-label">WALLET BALANCE</div>
        <div class="stat-value" id="stat-wallet">‚Äî</div>
        <div class="stat-sub">ISK</div>
      </div>
      <div class="stat-card">
        <div class="stat-corner">üìà</div>
        <div class="stat-label">TOTAL PROFIT (30D)</div>
        <div class="stat-value" id="stat-profit">‚Äî</div>
        <div class="stat-sub stat-up" id="stat-profit-sub">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-corner">üì¶</div>
        <div class="stat-label">ACTIVE ORDERS</div>
        <div class="stat-value" id="stat-orders">‚Äî</div>
        <div class="stat-sub">in market</div>
      </div>
      <div class="stat-card">
        <div class="stat-corner">‚ö°</div>
        <div class="stat-label">BEST MARGIN</div>
        <div class="stat-value" id="stat-margin">‚Äî</div>
        <div class="stat-sub" id="stat-margin-item">‚Äî</div>
      </div>
    </div>

    <div class="panel-row triple">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">PROFIT OVER TIME</div>
          <div class="wallet-time">
            <button class="time-btn active" onclick="setTimeRange(7, this)">7D</button>
            <button class="time-btn" onclick="setTimeRange(30, this)">30D</button>
            <button class="time-btn" onclick="setTimeRange(90, this)">90D</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="chart-wrap">
            <canvas id="profitChart"></canvas>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">SELL SIGNALS</div>
        </div>
        <div class="panel-body" id="signals-panel">
          <div class="no-data"><div class="lock-icon">üîê</div>CONNECT PILOT TO VIEW</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">TOP ITEMS</div>
        </div>
        <div class="panel-body" id="topItems-panel">
          <div class="no-data"><div class="lock-icon">üîê</div>CONNECT PILOT TO VIEW</div>
        </div>
      </div>
    </div>

    <div class="panel-row">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">RECENT TRANSACTIONS</div>
        </div>
        <div class="panel-body" style="padding:0">
          <div id="recentTx">
            <div class="no-data"><div class="lock-icon">üîê</div>CONNECT PILOT TO VIEW</div>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">VOLUME BY CATEGORY</div>
        </div>
        <div class="panel-body">
          <div class="chart-wrap">
            <canvas id="volumeChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TRANSACTIONS TAB -->
  <div class="tab-view" id="tab-transactions">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">WALLET TRANSACTIONS <span id="txHistoryCount" style="font-size:10px;color:var(--text-dim);font-family:Share Tech Mono,monospace;margin-left:8px"></span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="text" class="esi-input" placeholder="Filter item..." style="width:160px" oninput="filterTransactions(this.value)" />
          <select class="esi-input" style="width:100px" onchange="filterTxType(this.value)">
            <option value="all">ALL</option>
            <option value="buy">BUY</option>
            <option value="sell">SELL</option>
          </select>
          <button class="esi-btn" onclick="document.getElementById('csvImportFile').click()" style="border-color:var(--warn);color:var(--warn)">‚Üë IMPORT</button>
          <input type="file" id="csvImportFile" accept=".csv,.tsv,.txt" style="display:none" onchange="importCSV(this)" />
          <button class="esi-btn green" onclick="exportCSV()">‚Üì CSV</button>
          <button class="esi-btn" onclick="clearHistory()" style="border-color:var(--danger);color:var(--danger)" title="Clear stored history">‚úï CLEAR</button>
        </div>
      </div>
      <div style="padding:6px 16px;background:var(--deep);border-bottom:1px solid var(--border);font-family:Share Tech Mono,monospace;font-size:10px;color:var(--text-dim);display:flex;gap:16px;align-items:center">
        <span>üíæ History snapshots saved locally ¬∑ ‚Üë IMPORT accepts EVE wallet journal CSV or this dashboard's exports</span>
        <span id="txStorageUsed"></span>
      </div>
      <!-- Import result message -->
      <div id="importMsg" style="display:none;padding:8px 16px;background:var(--panel);border-bottom:1px solid var(--border);font-family:Share Tech Mono,monospace;font-size:11px"></div>
      <div class="panel-body" style="padding:0">
        <div id="txTableWrap">
          <div class="no-data"><div class="lock-icon">üîê</div>CONNECT PILOT TO VIEW</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ORDERS TAB -->
  <div class="tab-view" id="tab-orders">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">ACTIVE MARKET ORDERS</div>
      </div>
      <div class="panel-body" style="padding:0">
        <div id="ordersTableWrap">
          <div class="no-data"><div class="lock-icon">üîê</div>CONNECT PILOT TO VIEW</div>
        </div>
      </div>
    </div>
  </div>

  <!-- INVENTORY TAB -->
  <div class="tab-view" id="tab-inventory">
    <div class="panel-row">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">ASSET GRID</div>
        </div>
        <div class="panel-body">
          <div class="inv-grid" id="inventoryGrid">
            <div class="no-data" style="grid-column:1/-1"><div class="lock-icon">üîê</div>CONNECT PILOT TO VIEW</div>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">LOG TRADE</div>
        </div>
        <div class="panel-body">
          <div class="form-grid">
            <div class="form-group">
              <div class="form-label">Item Name</div>
              <input type="text" class="esi-input" id="trade-item" placeholder="e.g. PLEX" />
            </div>
            <div class="form-group">
              <div class="form-label">Type</div>
              <select class="esi-input" id="trade-type">
                <option value="buy">BUY</option>
                <option value="sell">SELL</option>
              </select>
            </div>
            <div class="form-group">
              <div class="form-label">Quantity</div>
              <input type="number" class="esi-input" id="trade-qty" placeholder="1" />
            </div>
            <div class="form-group">
              <div class="form-label">Unit Price (ISK)</div>
              <input type="number" class="esi-input" id="trade-price" placeholder="1000000" />
            </div>
          </div>
          <br/>
          <button class="esi-btn green" onclick="logTrade()" style="width:100%">+ LOG TRADE</button>
          <div id="tradeMsg" style="margin-top:8px; font-family:Share Tech Mono,monospace; font-size:11px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MARKET LOOKUP TAB -->
  <div class="tab-view" id="tab-lookup">
    <div class="panel-row">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">ITEM PRICE LOOKUP</div>
        </div>
        <div class="panel-body">
          <div class="input-row">
            <input type="text" class="esi-input" id="lookupInput" placeholder="Enter item name or Type ID (e.g. 'PLEX' or '44992')..." />
            <button class="esi-btn" onclick="lookupItem()">SCAN MARKET</button>
          </div>
          <div id="lookupResult" class="lookup-result">
            <div class="lookup-name" id="lookup-name">‚Äî</div>
            <div class="lookup-prices">
              <div class="lookup-price-item">
                <div class="lookup-price-label">JITA BUY</div>
                <div class="lookup-price-val isk-green" id="lookup-buy">‚Äî</div>
              </div>
              <div class="lookup-price-item">
                <div class="lookup-price-label">JITA SELL</div>
                <div class="lookup-price-val isk-red" id="lookup-sell">‚Äî</div>
              </div>
              <div class="lookup-price-item">
                <div class="lookup-price-label">MARGIN</div>
                <div class="lookup-price-val isk" id="lookup-margin">‚Äî</div>
              </div>
            </div>
            <div style="margin-top:12px">
              <div class="chart-wrap" style="height:160px">
                <canvas id="lookupChart"></canvas>
              </div>
            </div>
          </div>
          <div id="popularItems" style="margin-top:16px">
            <div style="font-family:Share Tech Mono,monospace; font-size:10px; color:var(--text-dim); letter-spacing:2px; margin-bottom:8px">POPULAR ITEMS</div>
            <div style="display:flex;flex-wrap:wrap;gap:6px" id="popularTags"></div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">PRICE HISTORY</div>
          <div style="display:flex;align-items:center;gap:10px">
            <span style="font-family:Share Tech Mono,monospace;font-size:10px;color:var(--text-dim)" id="sliderLabel">30 DAYS</span>
            <input type="range" id="historySlider" min="5" max="365" value="30" step="5"
              oninput="onHistorySlider(this.value)"
              style="width:120px;accent-color:var(--accent);cursor:pointer;height:4px" />
          </div>
        </div>
        <div class="panel-body">
          <div class="chart-wrap" style="height:280px">
            <canvas id="historyChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JITA TRACKER TAB -->
  <div class="tab-view" id="tab-jita">

    <div class="stats-row" style="grid-template-columns:repeat(3,1fr)">
      <div class="stat-card">
        <div class="stat-corner">üìç</div>
        <div class="stat-label">STATION</div>
        <div class="stat-value" style="font-size:16px">JITA IV-4</div>
        <div class="stat-sub">The Forge ¬∑ 10000002</div>
      </div>
      <div class="stat-card">
        <div class="stat-corner">üëÅ</div>
        <div class="stat-label">WATCHING</div>
        <div class="stat-value" id="jita-watching">0</div>
        <div class="stat-sub">items tracked</div>
      </div>
      <div class="stat-card">
        <div class="stat-corner">‚è±</div>
        <div class="stat-label">LAST SYNC</div>
        <div class="stat-value" style="font-size:16px" id="jita-lastsync">‚Äî</div>
        <div class="stat-sub">ESI cache: 5 min</div>
      </div>
    </div>

    <div class="panel-row">
      <div class="panel" style="flex:2">
        <div class="panel-header">
          <div class="panel-title">WATCH LIST</div>
          <div style="display:flex;gap:8px;align-items:center">
            <input type="text" class="esi-input" id="jitaSearchInput" placeholder="Search item to add..." style="width:220px"
              oninput="jitaSearch(this.value)" onkeydown="if(event.key==='Enter')addJitaItemByName()" />
            <button class="esi-btn" onclick="addJitaItemByName()">+ ADD</button>
            <button class="esi-btn" onclick="refreshAllJita()" style="border-color:var(--accent2);color:var(--accent2)">‚Üª SYNC ALL</button>
          </div>
        </div>
        <!-- Search suggestions -->
        <div id="jitaSuggestions" style="display:none;background:var(--deep);border:1px solid var(--border);border-top:none;max-height:160px;overflow-y:auto;position:relative;z-index:50"></div>
        <div style="padding:0">
          <table class="data-table" id="jitaWatchTable">
            <thead><tr>
              <th>ITEM</th>
              <th>JITA BUY</th>
              <th>JITA SELL</th>
              <th>SPREAD</th>
              <th>MARGIN %</th>
              <th>24H CHANGE</th>
              <th>MY AVG BUY</th>
              <th>UNREALISED P/L</th>
              <th></th>
            </tr></thead>
            <tbody id="jitaWatchBody">
              <tr><td colspan="9" class="no-data" style="padding:40px">Add items above to start tracking Jita prices</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="panel" style="flex:1;min-width:260px">
        <div class="panel-header">
          <div class="panel-title">PRICE CHART</div>
          <div id="jitaChartLabel" style="font-family:Share Tech Mono,monospace;font-size:10px;color:var(--text-dim)">SELECT ITEM</div>
        </div>
        <div class="panel-body">
          <div class="chart-wrap" style="height:200px">
            <canvas id="jitaChart"></canvas>
          </div>
          <div style="display:flex;gap:6px;margin-top:10px;justify-content:center">
            <button class="time-btn active" onclick="setJitaRange(7,this)">7D</button>
            <button class="time-btn" onclick="setJitaRange(30,this)">30D</button>
            <button class="time-btn" onclick="setJitaRange(90,this)">90D</button>
          </div>
          <div id="jitaChartStats" style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px"></div>
        </div>
      </div>
    </div>

    <!-- Inventory with Jita prices -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">INVENTORY ¬∑ JITA VALUE</div>
        <div style="font-family:Share Tech Mono,monospace;font-size:10px;color:var(--text-dim)">Est. value at current Jita sell prices</div>
      </div>
      <div style="padding:0">
        <table class="data-table" id="jitaInventoryTable">
          <thead><tr>
            <th>ITEM</th><th>QTY</th><th>JITA BUY</th><th>JITA SELL</th><th>TOTAL VALUE (SELL)</th><th>MARGIN</th><th>SIGNAL</th>
          </tr></thead>
          <tbody id="jitaInventoryBody">
            <tr><td colspan="7" class="no-data" style="padding:30px">Connect pilot or load demo to see inventory</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

</div><!-- /dashboard -->

<div class="footer">
  EVE TRADE OPS v1.0 ¬∑ NOT AN OFFICIAL CCP APPLICATION ¬∑ DATA VIA ESI (esi.evetech.net) ¬∑ EVE ONLINE ¬© CCP GAMES
</div>

</div><!-- /app -->

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let state = {
  connected: false,
  pilot: null,
  token: null,
  transactions: [],
  orders: [],
  assets: [],
  manualTrades: JSON.parse(localStorage.getItem('eve_manual_trades') || '[]'),
  currentTimeRange: 7
};

const ESI = 'https://esi.evetech.net/latest';
const MARKET_ESI = 'https://esi.evetech.net/latest/markets';

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CHARTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const chartDefaults = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: { legend: { display: false }, tooltip: {
    backgroundColor: '#0d1826', borderColor: '#1a3a5c', borderWidth: 1,
    titleColor: '#00c8ff', bodyColor: '#c8e0f0',
    titleFont: { family: 'Share Tech Mono', size: 10 },
    bodyFont: { family: 'Share Tech Mono', size: 11 }
  }},
  scales: {
    x: { grid: { color: 'rgba(26,58,92,0.4)', borderColor: '#1a3a5c' }, ticks: { color: '#5a7a95', font: { family: 'Share Tech Mono', size: 9 } } },
    y: { grid: { color: 'rgba(26,58,92,0.4)', borderColor: '#1a3a5c' }, ticks: { color: '#5a7a95', font: { family: 'Share Tech Mono', size: 9 }, callback: v => formatISKShort(v) } }
  }
};

let charts = {};

function initCharts() {
  const profitCtx = document.getElementById('profitChart').getContext('2d');
  charts.profit = new Chart(profitCtx, {
    type: 'line',
    data: { labels: [], datasets: [{ data: [], borderColor: '#00ff9d', backgroundColor: 'rgba(0,255,157,0.07)', borderWidth: 2, tension: 0.4, fill: true, pointRadius: 3, pointBackgroundColor: '#00ff9d' }] },
    options: { ...chartDefaults }
  });

  const volumeCtx = document.getElementById('volumeChart').getContext('2d');
  charts.volume = new Chart(volumeCtx, {
    type: 'doughnut',
    data: { labels: [], datasets: [{ data: [], backgroundColor: ['#00c8ff','#00ff9d','#ff6b35','#ffbb00','#ff3355','#8b5cf6'], borderWidth: 0, hoverOffset: 8 }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: true, position: 'right', labels: { color: '#5a7a95', font: { family: 'Share Tech Mono', size: 9 }, boxWidth: 10, padding: 8 }},
        tooltip: chartDefaults.plugins.tooltip
      }
    }
  });

  const histCtx = document.getElementById('historyChart').getContext('2d');
  charts.history = new Chart(histCtx, {
    type: 'candlestick',
    data: { datasets: [] },
    options: { responsive: true, maintainAspectRatio: false }
  });

  // Use line for history since candlestick needs extra plugin
  charts.history.destroy();
  charts.history = new Chart(histCtx, {
    type: 'line',
    data: { labels: [], datasets: [
      { label: 'HIGH', data: [], borderColor: '#00ff9d', borderWidth: 1.5, borderDash: [4,2], pointRadius: 0, tension: 0.3, fill: false },
      { label: 'AVG', data: [], borderColor: '#00c8ff', backgroundColor: 'rgba(0,200,255,0.06)', borderWidth: 2, pointRadius: 2, tension: 0.3, fill: '-1' },
      { label: 'LOW', data: [], borderColor: '#ff6b35', borderWidth: 1.5, borderDash: [4,2], pointRadius: 0, tension: 0.3, fill: false }
    ]},
    options: { ...chartDefaults, plugins: { ...chartDefaults.plugins, legend: { display: true, labels: { color: '#5a7a95', font: { family: 'Share Tech Mono', size: 9 }, boxWidth: 10, padding: 8 } } } }
  });

  const lookCtx = document.getElementById('lookupChart').getContext('2d');
  charts.lookup = new Chart(lookCtx, {
    type: 'line',
    data: { labels: [], datasets: [{ label: 'PRICE', data: [], borderColor: '#00c8ff', backgroundColor: 'rgba(0,200,255,0.08)', borderWidth: 2, tension: 0.4, fill: true, pointRadius: 0 }] },
    options: { ...chartDefaults, scales: { ...chartDefaults.scales, x: { ...chartDefaults.scales.x, display: false } } }
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  FORMAT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function formatISK(n) {
  if (n === null || n === undefined || isNaN(n)) return '‚Äî';
  return Math.abs(n) >= 1e12 ? (n/1e12).toFixed(2)+'T'
       : Math.abs(n) >= 1e9  ? (n/1e9).toFixed(2)+'B'
       : Math.abs(n) >= 1e6  ? (n/1e6).toFixed(2)+'M'
       : Math.abs(n) >= 1e3  ? (n/1e3).toFixed(1)+'K'
       : n.toFixed(0);
}

function formatISKFull(n) {
  return new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(n);
}

function formatISKShort(n) { return formatISK(n); }

function formatDate(d) {
  const dt = new Date(d);
  return dt.toLocaleDateString('en-GB', { day:'2-digit', month:'short' });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  DEMO DATA
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEMO_ITEMS = [
  { name: 'PLEX', typeId: 44992, category: 'PLEX' },
  { name: 'Tritanium', typeId: 34, category: 'Minerals' },
  { name: 'Mexallon', typeId: 36, category: 'Minerals' },
  { name: 'Pyerite', typeId: 35, category: 'Minerals' },
  { name: 'Isogen', typeId: 37, category: 'Minerals' },
  { name: 'Blueprint: Rifter', typeId: 774, category: 'Blueprints' },
  { name: 'Zydrine', typeId: 39, category: 'Minerals' },
  { name: "Skill Injector", typeId: 40520, category: 'Skills' },
  { name: 'Ferox', typeId: 16229, category: 'Ships' },
  { name: 'Antimatter Charge S', typeId: 229, category: 'Ammunition' }
];

function genDemoTransactions(days = 90) {
  const tx = [];
  const now = Date.now();
  const dayMs = 86400000;
  for (let i = 0; i < 120; i++) {
    const item = DEMO_ITEMS[Math.floor(Math.random() * DEMO_ITEMS.length)];
    const isBuy = Math.random() > 0.45;
    const basePrice = Math.random() * 50e6 + 100000;
    const qty = Math.floor(Math.random() * 50) + 1;
    tx.push({
      transaction_id: i + 1,
      date: new Date(now - Math.random() * days * dayMs).toISOString(),
      type_id: item.typeId,
      item_name: item.name,
      category: item.category,
      is_buy: isBuy,
      quantity: qty,
      unit_price: basePrice,
      total: basePrice * qty,
      location_id: 60003760,
      location_name: 'Jita IV - Moon 4 - Caldari Navy Assembly Plant'
    });
  }
  return tx.sort((a, b) => new Date(b.date) - new Date(a.date));
}

function genDemoOrders() {
  const orders = [];
  for (let i = 0; i < 12; i++) {
    const item = DEMO_ITEMS[Math.floor(Math.random() * DEMO_ITEMS.length)];
    const isBuy = Math.random() > 0.5;
    const basePrice = Math.random() * 50e6 + 100000;
    const volTotal = Math.floor(Math.random() * 100) + 10;
    const volRemain = Math.floor(Math.random() * volTotal);
    orders.push({
      order_id: 9000 + i,
      type_id: item.typeId,
      item_name: item.name,
      is_buy_order: isBuy,
      price: basePrice,
      volume_total: volTotal,
      volume_remain: volRemain,
      issued: new Date(Date.now() - Math.random() * 14 * 86400000).toISOString(),
      duration: 90,
      location_id: 60003760
    });
  }
  return orders;
}

function genDemoAssets() {
  return DEMO_ITEMS.slice(0, 8).map((item, i) => ({
    type_id: item.typeId,
    item_name: item.name,
    quantity: Math.floor(Math.random() * 500) + 1,
    est_value: (Math.random() * 20e6 + 50000) * (Math.floor(Math.random() * 500) + 1),
    icon: ['üíé','‚õèÔ∏è','üöÄ','üîã','üõ°Ô∏è','‚ö°','üåü','üíä'][i % 8]
  }));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  LOAD DEMO
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadDemoData() {
  closeModal();
  showLoading();

  setTimeout(() => {
    state.connected = true;
    state.pilot = { name: 'Omega Trader', corp: 'Jita Trading Co.', id: 12345 };
    state.transactions = genDemoTransactions();
    state.orders = genDemoOrders();
    state.assets = genDemoAssets();

    updateUI();
    hideLoading();
    setConnectedState();
  }, 1200);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  PKCE HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function base64URLEncode(buffer) {
  return btoa(String.fromCharCode(...new Uint8Array(buffer)))
    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

async function generateCodeVerifier() {
  const array = new Uint8Array(64);
  crypto.getRandomValues(array);
  return base64URLEncode(array);
}

async function generateCodeChallenge(verifier) {
  const encoded = new TextEncoder().encode(verifier);
  const digest = await crypto.subtle.digest('SHA-256', encoded);
  return base64URLEncode(digest);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  PKCE FLOW
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const REDIRECT_URI = 'https://mrevind.github.io/evetrader/';
const ESI_SCOPES = [
  'esi-wallet.read_character_wallet.v1',
  'esi-markets.read_character_orders.v1',
  'esi-assets.read_assets.v1'
].join(' ');

async function launchPKCE() {
  const clientId = localStorage.getItem('eve_client_id');
  if (!clientId) { alert('No Client ID saved. Go back to step 2.'); return; }

  const verifier  = await generateCodeVerifier();
  const challenge = await generateCodeChallenge(verifier);
  const stateVal  = base64URLEncode(crypto.getRandomValues(new Uint8Array(16)));

  localStorage.setItem('pkce_verifier', verifier);
  localStorage.setItem('pkce_state',    stateVal);

  const redirect = encodeURIComponent(REDIRECT_URI);
  const url = `${EVE_SSO}/authorize`
    + `?response_type=code`
    + `&client_id=${encodeURIComponent(clientId)}`
    + `&redirect_uri=${redirect}`
    + `&scope=${encodeURIComponent(ESI_SCOPES)}`
    + `&state=${stateVal}`
    + `&code_challenge=${challenge}`
    + `&code_challenge_method=S256`;

  location.href = url;
}

async function exchangeCodePKCE(code) {
  const clientId = localStorage.getItem('eve_client_id');
  const verifier = localStorage.getItem('pkce_verifier');
  const redirect = REDIRECT_URI;

  const res = await fetch(`${EVE_SSO}/token`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      grant_type:    'authorization_code',
      code,
      client_id:     clientId,
      code_verifier: verifier,
      redirect_uri:  redirect
    })
  });

  if (!res.ok) {
    const err = await res.text();
    throw new Error('Token exchange failed: ' + err);
  }
  return res.json(); // { access_token, refresh_token, expires_in, ... }
}

async function refreshAccessToken() {
  const clientId     = localStorage.getItem('eve_client_id');
  const refreshToken = localStorage.getItem('eve_refresh_token');
  if (!clientId || !refreshToken) throw new Error('No refresh token');

  const res = await fetch(`${EVE_SSO}/token`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      grant_type:    'refresh_token',
      refresh_token: refreshToken,
      client_id:     clientId
    })
  });

  if (!res.ok) throw new Error('Token refresh failed');
  const data = await res.json();
  storeTokens(data);
  return data.access_token;
}

function storeTokens(data) {
  localStorage.setItem('eve_access_token',  data.access_token);
  localStorage.setItem('eve_refresh_token', data.refresh_token || localStorage.getItem('eve_refresh_token'));
  localStorage.setItem('eve_token_expiry',  Date.now() + data.expires_in * 1000);
}

async function getValidToken() {
  const expiry = parseInt(localStorage.getItem('eve_token_expiry') || '0');
  if (Date.now() < expiry - 60000) {
    return localStorage.getItem('eve_access_token');
  }
  return refreshAccessToken();
}

async function getCharacterInfo(token) {
  // Decode JWT to get character ID
  const payload = JSON.parse(atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
  const subParts = payload.sub.split(':'); // "CHARACTER:EVE:12345678"
  const charId = subParts[subParts.length - 1];

  const res = await fetch(`${ESI}/characters/${charId}/`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const info = await res.json();
  return { id: charId, name: info.name, corp: info.corporation_id };
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  ESI AUTHENTICATED CALLS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchCharacterData(charId) {
  const token = await getValidToken();
  const headers = { Authorization: `Bearer ${token}` };

  const [txRes, ordersRes, assetsRes, walletRes] = await Promise.all([
    fetch(`${ESI}/characters/${charId}/wallet/transactions/?datasource=tranquility`, { headers }),
    fetch(`${ESI}/characters/${charId}/orders/?datasource=tranquility`, { headers }),
    fetch(`${ESI}/characters/${charId}/assets/?datasource=tranquility`, { headers }),
    fetch(`${ESI}/characters/${charId}/wallet/?datasource=tranquility`, { headers })
  ]);

  const [transactions, orders, assets, wallet] = await Promise.all([
    txRes.ok     ? txRes.json()     : [],
    ordersRes.ok ? ordersRes.json() : [],
    assetsRes.ok ? assetsRes.json() : [],
    walletRes.ok ? walletRes.json() : 0
  ]);

  // Enrich transactions with item names
  const typeIds = [...new Set([
    ...transactions.map(t => t.type_id),
    ...orders.map(o => o.type_id),
    ...assets.slice(0, 50).map(a => a.type_id)
  ])];

  const nameMap = await resolveTypeNames(typeIds);

  const enrichedTx = transactions.map(t => ({
    ...t,
    item_name: nameMap[t.type_id] || `Type ${t.type_id}`,
    category: 'Market',
    total: t.unit_price * t.quantity,
    date: t.date
  }));

  const enrichedOrders = orders.map(o => ({
    ...o,
    item_name: nameMap[o.type_id] || `Type ${o.type_id}`
  }));

  const enrichedAssets = assets.slice(0, 30).map((a, i) => ({
    ...a,
    item_name: nameMap[a.type_id] || `Type ${a.type_id}`,
    est_value: 0,
    icon: ['üíé','‚õèÔ∏è','üöÄ','üîã','üõ°Ô∏è','‚ö°','üåü','üíä','üîß','üì¶','üéØ','üí†'][i % 12]
  }));

  return { transactions: enrichedTx, orders: enrichedOrders, assets: enrichedAssets, wallet };
}

async function resolveTypeNames(typeIds) {
  if (!typeIds.length) return {};
  try {
    const res = await fetch(`${ESI}/universe/names/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(typeIds.slice(0, 500))
    });
    if (!res.ok) return {};
    const names = await res.json();
    return Object.fromEntries(names.map(n => [n.id, n.name]));
  } catch(e) { return {}; }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  OAUTH CALLBACK HANDLER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async function handleCallback() {
  const params   = new URLSearchParams(location.search);
  const code     = params.get('code');
  const returned = params.get('state');
  const stored   = localStorage.getItem('pkce_state');

  if (!code || !returned || returned !== stored) return;

  // Clean URL immediately
  history.replaceState({}, document.title, location.pathname);

  showLoading();
  try {
    const tokenData = await exchangeCodePKCE(code);
    storeTokens(tokenData);
    localStorage.removeItem('pkce_verifier');
    localStorage.removeItem('pkce_state');

    const charInfo = await getCharacterInfo(tokenData.access_token);
    localStorage.setItem('eve_char_id',   charInfo.id);
    localStorage.setItem('eve_char_name', charInfo.name);

    const { transactions, orders, assets, wallet } = await fetchCharacterData(charInfo.id);

    state.connected    = true;
    state.pilot        = { name: charInfo.name, corp: 'Corporation', id: charInfo.id };
    state.transactions = mergeAndSaveHistory(transactions);
    state.orders       = orders;
    state.assets       = assets;
    state.wallet       = wallet;

    updateUI();
    setConnectedState();
  } catch(err) {
    console.error('Auth error:', err);
    hideLoading();
    alert('Authentication error: ' + err.message + '\n\nPlease try again or use Demo Mode.');
    openModal();
    return;
  }
  hideLoading();
})();

// Try restoring session on load
async function tryRestoreSession() {
  const charId   = localStorage.getItem('eve_char_id');
  const charName = localStorage.getItem('eve_char_name');
  if (!charId || !charName) return false;

  try {
    const token = await getValidToken();
    if (!token) return false;

    showLoading();
    // Load stored history immediately so UI has data while fetching
    state.transactions = loadStoredHistory();

    const { transactions, orders, assets, wallet } = await fetchCharacterData(charId);
    state.connected    = true;
    state.pilot        = { name: charName, corp: 'Corporation', id: charId };
    state.transactions = mergeAndSaveHistory(transactions);
    state.orders       = orders;
    state.assets       = assets;
    state.wallet       = wallet;

    updateUI();
    setConnectedState();
    hideLoading();
    return true;
  } catch(e) {
    console.warn('Session restore failed:', e);
    hideLoading();
    return false;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  ESI API CALLS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function esiFetch(path, token = null) {
  const headers = { 'Content-Type': 'application/json' };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(`${ESI}${path}`, { headers });
  if (!res.ok) throw new Error(`ESI ${res.status}: ${path}`);
  return res.json();
}

async function lookupTypeId(name) {
  // Try ESI search (public endpoint)
  try {
    const encoded = encodeURIComponent(name);
    const res = await fetch(`${ESI}/search/?categories=inventory_type&search=${encoded}&strict=false`);
    const data = await res.json();
    if (data.inventory_type && data.inventory_type.length > 0) return data.inventory_type[0];
  } catch(e) {}
  return null;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  ADAM4EVE + ESI HYBRID MARKET DATA
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const A4E = 'https://api.adam4eve.eu/v1';
const A4E_UA = { 'User-Agent': 'EVETradeOps/1.0 github.com/mrevind/evetrader' };

// Fetch live best buy/sell from ESI orderbook (current day, freshest data)
async function fetchLivePrices(typeId) {
  try {
    const res = await fetch(
      `https://esi.evetech.net/latest/markets/${JITA_REGION}/orders/?type_id=${typeId}&order_type=all`
    );
    const orders = res.ok ? await res.json() : [];
    const jita   = orders.filter(o => o.location_id === JITA_STATION);
    const all    = jita.length ? jita : orders;
    const buys   = all.filter(o =>  o.is_buy_order);
    const sells  = all.filter(o => !o.is_buy_order);
    return {
      buy:         buys.length  ? Math.max(...buys.map(o => o.price))  : null,
      sell:        sells.length ? Math.min(...sells.map(o => o.price)) : null,
      buy_volume:  buys.reduce((s, o) => s + o.volume_remain, 0),
      sell_volume: sells.reduce((s, o) => s + o.volume_remain, 0),
      source:      'ESI'
    };
  } catch(e) {
    return { buy: null, sell: null, buy_volume: 0, sell_volume: 0, source: 'ESI' };
  }
}

// Fetch price history from Adam4EVE (separate buy/sell lines, up to 1 year)
async function fetchA4EHistory(typeId, start = null, end = null) {
  try {
    const startDate = start || new Date(Date.now() - 90 * 86400000).toISOString().split('T')[0];
    const endDate   = end   || new Date().toISOString().split('T')[0];
    const url = `${A4E}/market_price_history?typeID=${typeId}&regionID=${JITA_REGION}&start=${startDate}&end=${endDate}`;
    const res = await fetch(url, { headers: A4E_UA });
    if (!res.ok) return [];
    return await res.json(); // array of { type_id, price_date, buy_price_avg, sell_price_avg, buy_price_high, sell_price_low, ... }
  } catch(e) {
    return [];
  }
}

// Fetch current prices from Adam4EVE (updated every ~10 min, good fallback)
async function fetchA4EPrices(typeIds) {
  try {
    const ids = Array.isArray(typeIds) ? typeIds.join(',') : typeIds;
    const res = await fetch(`${A4E}/market_prices?typeID=${ids}&locationID=${JITA_REGION}`, { headers: A4E_UA });
    if (!res.ok) return {};
    const data = await res.json();
    // Index by type_id
    const map = {};
    (Array.isArray(data) ? data : [data]).forEach(d => { map[d.type_id] = d; });
    return map;
  } catch(e) {
    return {};
  }
}

// Main combined fetch ‚Äî ESI for live + A4E for history
async function fetchMarketPrices(typeId) {
  const [live, history] = await Promise.all([
    fetchLivePrices(typeId),
    fetchA4EHistory(typeId)
  ]);
  return {
    orders:  [], // not used anymore
    history: history, // A4E format
    live                // ESI live
  };
}

// Rate-limited A4E fetch queue (1 req per 5 sec)
const a4eQueue = [];
let a4eProcessing = false;

function queueA4EFetch(fn) {
  return new Promise((resolve, reject) => {
    a4eQueue.push({ fn, resolve, reject });
    if (!a4eProcessing) processA4EQueue();
  });
}

async function processA4EQueue() {
  a4eProcessing = true;
  while (a4eQueue.length) {
    const { fn, resolve, reject } = a4eQueue.shift();
    try { resolve(await fn()); } catch(e) { reject(e); }
    if (a4eQueue.length) await new Promise(r => setTimeout(r, 5100)); // 5.1s gap
  }
  a4eProcessing = false;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MARKET LOOKUP
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function lookupItem() {
  const input = document.getElementById('lookupInput').value.trim();
  if (!input) return;

  showLoading();
  try {
    let typeId = parseInt(input);
    let itemName = input;

    if (isNaN(typeId)) {
      typeId = await lookupTypeId(input);
      if (!typeId) {
        const demoMap = { 'plex': { id: 44992, name: 'PLEX', buy: 4850000, sell: 4900000 }, 'tritanium': { id: 34, name: 'Tritanium', buy: 5.2, sell: 5.5 }, 'skill injector': { id: 40520, name: 'Skill Injector', buy: 820000000, sell: 850000000 } };
        const key = input.toLowerCase();
        const demo = demoMap[key];
        if (demo) {
          showLookupResult(demo.name, demo.buy, demo.sell, generateDemoHistory(demo.buy));
          hideLoading(); return;
        }
        showLookupResult(input + ' (DEMO)', 12500000, 13200000, generateDemoHistory(12500000));
        hideLoading(); return;
      }
    }

    // Get item name
    try {
      const typeInfo = await esiFetch(`/universe/types/${typeId}/`);
      itemName = typeInfo.name;
    } catch(e) {}

    // Fetch live ESI price + A4E history in parallel
    const [live, a4eHistory] = await Promise.all([
      fetchLivePrices(typeId),
      queueA4EFetch(() => fetchA4EHistory(typeId, null, null))
    ]);

    showLookupResult(itemName, live.buy, live.sell, a4eHistory, typeId);
  } catch(e) {
    showLookupResult(input + ' (DEMO)', 12500000, 13200000, generateDemoHistory(12500000));
  }
  hideLoading();
}

function generateDemoHistory(basePrice, days = 365) {
  const data = [];
  let price = basePrice;
  for (let i = days; i >= 0; i--) {
    price *= (1 + (Math.random() - 0.5) * 0.04);
    data.push({
      date: new Date(Date.now() - i * 86400000).toISOString().split('T')[0],
      average: price,
      highest: price * (1 + Math.random() * 0.02),
      lowest: price * (1 - Math.random() * 0.02)
    });
  }
  return data;
}

// Store full history for slider ‚Äî now in A4E format
let currentFullHistory = [];
let currentLivePrice   = {};

function showLookupResult(name, buy, sell, history, typeId) {
  // history can be A4E format (buy_price_avg/sell_price_avg) or legacy (average/highest/lowest)
  currentFullHistory = history || [];
  currentLivePrice   = { buy, sell, typeId };

  document.getElementById('lookup-name').textContent = name + ' ¬∑ JITA IV-4';
  document.getElementById('lookup-buy').textContent  = buy  ? formatISKFull(buy)  + ' ISK' : '‚Äî';
  document.getElementById('lookup-sell').textContent = sell ? formatISKFull(sell) + ' ISK' : '‚Äî';

  if (buy && sell) {
    const margin = ((sell - buy) / sell * 100).toFixed(1);
    document.getElementById('lookup-margin').textContent = margin + '%';
    document.getElementById('lookup-margin').style.color = parseFloat(margin) > 10 ? 'var(--accent2)' : parseFloat(margin) > 0 ? 'var(--warn)' : 'var(--danger)';
  } else {
    document.getElementById('lookup-margin').textContent = '‚Äî';
  }

  document.getElementById('lookupResult').classList.add('show');

  const slider = document.getElementById('historySlider');
  const defaultDays = Math.min(30, history.length);
  slider.max   = Math.min(365, history.length || 1);
  slider.value = defaultDays;
  updateHistoryChart(defaultDays);
}

function isA4EFormat(history) {
  return history.length && history[0].buy_price_avg !== undefined;
}

function updateHistoryChart(days) {
  const sliced = currentFullHistory.slice(-days);
  document.getElementById('sliderLabel').textContent = days + ' DAYS';

  if (!sliced.length) return;

  const a4e = isA4EFormat(sliced);

  // Sparkline ‚Äî sell avg
  const sparkSlice = currentFullHistory.slice(-30);
  charts.lookup.data.labels = sparkSlice.map(h => formatDate(a4e ? h.price_date : h.date));
  charts.lookup.data.datasets[0].data = sparkSlice.map(h => a4e ? h.sell_price_avg : h.average);
  charts.lookup.update();

  // Full history chart ‚Äî separate buy/sell lines from A4E
  if (a4e) {
    charts.history.data.labels = sliced.map(h => formatDate(h.price_date));
    charts.history.data.datasets[0].data = sliced.map(h => h.sell_price_high);
    charts.history.data.datasets[1].data = sliced.map(h => h.sell_price_avg);
    charts.history.data.datasets[2].data = sliced.map(h => h.buy_price_avg);

    // Update labels to reflect A4E data
    charts.history.data.datasets[0].label = 'SELL HIGH';
    charts.history.data.datasets[1].label = 'SELL AVG';
    charts.history.data.datasets[2].label = 'BUY AVG';
    charts.history.data.datasets[0].borderColor = '#ff6b35';
    charts.history.data.datasets[1].borderColor = '#00c8ff';
    charts.history.data.datasets[2].borderColor = '#00ff9d';
  } else {
    // Legacy ESI format fallback
    charts.history.data.labels = sliced.map(h => formatDate(h.date));
    charts.history.data.datasets[0].data = sliced.map(h => h.highest);
    charts.history.data.datasets[1].data = sliced.map(h => h.average);
    charts.history.data.datasets[2].data = sliced.map(h => h.lowest);
    charts.history.data.datasets[0].label = 'HIGH';
    charts.history.data.datasets[1].label = 'AVG';
    charts.history.data.datasets[2].label = 'LOW';
  }
  charts.history.update();
}

function onHistorySlider(val) {
  updateHistoryChart(parseInt(val));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  UPDATE UI
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateUI() {
  updateStats();
  updateProfitChart();
  updateVolumeChart();
  updateSignals();
  updateTopItems();
  updateRecentTx();
  updateTransactionsTable();
  updateOrdersTable();
  updateInventory();
  updateJitaInventory();
  autoPopulateWatchList();
}

function updateStats() {
  const wallet = state.wallet || (4250000000 + Math.random() * 1e9);
  document.getElementById('stat-wallet').textContent = formatISK(wallet);

  const profits = state.transactions.filter(t => !t.is_buy);
  const costs = state.transactions.filter(t => t.is_buy);
  const totalProfit = profits.reduce((s, t) => s + t.total, 0) - costs.reduce((s, t) => s + t.total, 0);
  document.getElementById('stat-profit').textContent = formatISK(Math.abs(totalProfit));
  document.getElementById('stat-profit-sub').textContent = totalProfit >= 0 ? '‚ñ≤ +' + formatISK(totalProfit) : '‚ñº ' + formatISK(totalProfit);
  document.getElementById('stat-profit-sub').className = 'stat-sub ' + (totalProfit >= 0 ? 'stat-up' : 'stat-down');

  document.getElementById('stat-orders').textContent = state.orders.length;

  const margins = [];
  const buys = {};
  state.transactions.filter(t => t.is_buy).forEach(t => { if (!buys[t.item_name]) buys[t.item_name] = t.unit_price; });
  state.transactions.filter(t => !t.is_buy).forEach(t => {
    if (buys[t.item_name]) {
      const m = ((t.unit_price - buys[t.item_name]) / t.unit_price * 100);
      margins.push({ name: t.item_name, m });
    }
  });

  if (margins.length) {
    const best = margins.sort((a, b) => b.m - a.m)[0];
    document.getElementById('stat-margin').textContent = best.m.toFixed(1) + '%';
    document.getElementById('stat-margin-item').textContent = best.name;
  }
}

function updateProfitChart(days = 7) {
  const labels = [];
  const data = [];
  let running = 0;
  const now = Date.now();
  for (let i = days - 1; i >= 0; i--) {
    const dayStart = now - (i + 1) * 86400000;
    const dayEnd = now - i * 86400000;
    const dayTx = state.transactions.filter(t => {
      const d = new Date(t.date).getTime();
      return d >= dayStart && d < dayEnd;
    });
    const dayProfit = dayTx.filter(t => !t.is_buy).reduce((s, t) => s + t.total, 0)
                    - dayTx.filter(t => t.is_buy).reduce((s, t) => s + t.total, 0);
    running += dayProfit;
    labels.push(formatDate(new Date(dayEnd)));
    data.push(running);
  }

  charts.profit.data.labels = labels;
  charts.profit.data.datasets[0].data = data;
  charts.profit.update();
}

function updateVolumeChart() {
  const catMap = {};
  state.transactions.forEach(t => {
    catMap[t.category] = (catMap[t.category] || 0) + t.total;
  });
  const entries = Object.entries(catMap).sort((a, b) => b[1] - a[1]).slice(0, 6);
  charts.volume.data.labels = entries.map(e => e[0]);
  charts.volume.data.datasets[0].data = entries.map(e => e[1]);
  charts.volume.update();
}

function updateSignals() {
  const buyMap = {};
  const sellMap = {};
  state.transactions.filter(t => t.is_buy).forEach(t => {
    if (!buyMap[t.item_name]) buyMap[t.item_name] = { price: t.unit_price, name: t.item_name };
  });
  state.transactions.filter(t => !t.is_buy).forEach(t => {
    if (!sellMap[t.item_name]) sellMap[t.item_name] = { price: t.unit_price, name: t.item_name };
  });

  const signals = [];
  for (const name in buyMap) {
    const sellInfo = sellMap[name];
    const marketSell = buyMap[name].price * (1 + 0.05 + Math.random() * 0.3);
    const margin = ((marketSell - buyMap[name].price) / marketSell * 100);
    signals.push({
      name,
      buyPrice: buyMap[name].price,
      marketSell,
      margin,
      signal: margin > 15 ? 'sell' : margin > 5 ? 'wait' : 'buy'
    });
  }

  signals.sort((a, b) => b.margin - a.margin);

  const html = signals.slice(0, 5).map(s => `
    <div class="rec-item">
      <div class="rec-signal ${s.signal}">${s.signal === 'sell' ? '‚Üë' : s.signal === 'buy' ? '‚Üì' : '‚óè'}</div>
      <div class="rec-info">
        <div class="rec-name">${s.name}</div>
        <div class="rec-detail">BUY: ${formatISK(s.buyPrice)} ‚Üí SELL: ${formatISK(s.marketSell)}</div>
      </div>
      <div>
        <div class="rec-profit ${s.margin > 0 ? 'pos' : 'neg'}">${s.margin.toFixed(1)}%</div>
        <div style="font-size:9px;font-family:Share Tech Mono,monospace;color:var(--text-dim);text-align:right">${s.signal.toUpperCase()}</div>
      </div>
    </div>
  `).join('');

  document.getElementById('signals-panel').innerHTML = html || '<div class="no-data">NO SIGNALS</div>';
}

function updateTopItems() {
  const itemMap = {};
  state.transactions.filter(t => !t.is_buy).forEach(t => {
    if (!itemMap[t.item_name]) itemMap[t.item_name] = 0;
    itemMap[t.item_name] += t.total;
  });
  const top = Object.entries(itemMap).sort((a, b) => b[1] - a[1]).slice(0, 6);
  const max = top[0] ? top[0][1] : 1;

  const html = top.map(([name, val]) => `
    <div style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;margin-bottom:3px">
        <span style="font-size:12px;color:var(--text-bright);font-weight:600">${name}</span>
        <span class="isk-green" style="font-family:Share Tech Mono,monospace;font-size:11px">${formatISK(val)}</span>
      </div>
      <div class="profit-bar"><div class="profit-bar-fill" style="width:${(val/max*100).toFixed(0)}%"></div></div>
    </div>
  `).join('');

  document.getElementById('topItems-panel').innerHTML = html || '<div class="no-data">NO DATA</div>';
}

function updateRecentTx() {
  const recent = state.transactions.slice(0, 8);
  if (!recent.length) { document.getElementById('recentTx').innerHTML = '<div class="no-data">NO TRANSACTIONS</div>'; return; }
  const html = `<table class="data-table">
    <thead><tr>
      <th>DATE</th><th>ITEM</th><th>TYPE</th><th>QTY</th><th>UNIT PRICE</th><th>TOTAL</th>
    </tr></thead>
    <tbody>${recent.map(t => `
      <tr>
        <td style="font-family:Share Tech Mono,monospace;font-size:11px;color:var(--text-dim)">${formatDate(t.date)}</td>
        <td><div class="item-name item-link" onclick="quickLookup('${t.item_name}')">${t.item_name}</div><div class="item-type">${t.category}</div></td>
        <td><span class="status-badge ${t.is_buy ? 'status-buy' : 'status-sell'}">${t.is_buy ? 'BUY' : 'SELL'}</span></td>
        <td><span class="qty-badge">${t.quantity.toLocaleString()}</span></td>
        <td class="isk">${formatISK(t.unit_price)}</td>
        <td class="${t.is_buy ? 'isk-red' : 'isk-green'}">${t.is_buy ? '-' : '+'}${formatISK(t.total)}</td>
      </tr>
    `).join('')}</tbody>
  </table>`;
  document.getElementById('recentTx').innerHTML = html;
}

function updateTransactionsTable(filter = '', typeFilter = 'all') {
  if (!state.connected) return;
  let txs = state.transactions;
  if (filter) txs = txs.filter(t => t.item_name.toLowerCase().includes(filter.toLowerCase()));
  if (typeFilter === 'buy') txs = txs.filter(t => t.is_buy);
  if (typeFilter === 'sell') txs = txs.filter(t => !t.is_buy);

  const html = `<table class="data-table">
    <thead><tr>
      <th>DATE</th><th>ITEM</th><th>TYPE</th><th>QTY</th><th>UNIT PRICE</th><th>TOTAL</th><th>LOCATION</th>
    </tr></thead>
    <tbody>${txs.slice(0, 50).map(t => `
      <tr>
        <td style="font-family:Share Tech Mono,monospace;font-size:10px;color:var(--text-dim);white-space:nowrap">${new Date(t.date).toLocaleDateString()}</td>
        <td><div class="item-name item-link" onclick="quickLookup('${t.item_name}')">${t.item_name}</div><div class="item-type">ID: ${t.type_id}</div></td>
        <td><span class="status-badge ${t.is_buy ? 'status-buy' : 'status-sell'}">${t.is_buy ? 'BUY' : 'SELL'}</span></td>
        <td class="qty-badge">${t.quantity.toLocaleString()}</td>
        <td class="isk">${formatISKFull(t.unit_price)} ISK</td>
        <td class="${t.is_buy ? 'isk-red' : 'isk-green'}">${t.is_buy ? '-' : '+'}${formatISK(t.total)}</td>
        <td style="font-size:11px;color:var(--text-dim)">Jita IV-4</td>
      </tr>
    `).join('')}</tbody>
  </table>`;
  document.getElementById('txTableWrap').innerHTML = html;
}

function updateOrdersTable() {
  if (!state.connected) return;
  const html = `<table class="data-table">
    <thead><tr>
      <th>ITEM</th><th>TYPE</th><th>PRICE</th><th>VOL REMAIN</th><th>VOL TOTAL</th><th>PROGRESS</th><th>ISSUED</th>
    </tr></thead>
    <tbody>${state.orders.map(o => {
      const pct = Math.round((1 - o.volume_remain/o.volume_total)*100);
      return `<tr>
        <td><div class="item-name item-link" onclick="quickLookup('${o.item_name}')">${o.item_name}</div></td>
        <td><span class="status-badge ${o.is_buy_order ? 'status-buy' : 'status-sell'}">${o.is_buy_order ? 'BUY' : 'SELL'}</span></td>
        <td class="isk">${formatISKFull(o.price)} ISK</td>
        <td class="qty-badge">${o.volume_remain.toLocaleString()}</td>
        <td class="qty-badge">${o.volume_total.toLocaleString()}</td>
        <td>
          <div class="profit-bar-wrap">
            <div class="profit-bar"><div class="profit-bar-fill" style="width:${pct}%;background:${o.is_buy_order ? 'var(--accent)' : 'var(--accent3)'}"></div></div>
            <span style="font-family:Share Tech Mono,monospace;font-size:10px;color:var(--text-dim)">${pct}%</span>
          </div>
        </td>
        <td style="font-size:11px;color:var(--text-dim)">${formatDate(o.issued)}</td>
      </tr>`;
    }).join('')}</tbody>
  </table>`;
  document.getElementById('ordersTableWrap').innerHTML = html;
}

function updateInventory() {
  if (!state.connected) return;
  const cells = state.assets.map(a => `
    <div class="inv-cell" onclick="quickLookup('${a.item_name}')">
      <div class="inv-cell-icon">${a.icon}</div>
      <div class="inv-cell-name">${a.item_name}</div>
      <div class="inv-cell-qty">x${a.quantity.toLocaleString()}</div>
      <div class="inv-cell-val">${formatISK(a.est_value)}</div>
    </div>
  `).join('');
  document.getElementById('inventoryGrid').innerHTML = cells;
}

function quickLookup(name) {
  switchTab('lookup', document.querySelector('[onclick*="lookup"]'));
  document.getElementById('lookupInput').value = name;
  lookupItem();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  POPULAR ITEMS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initPopularItems() {
  const items = ['PLEX', 'Skill Injector', 'Tritanium', 'Caldari Navy Caracal', 'Isotopes', 'Zydrine', 'Blueprint', 'Raven', 'Drake BPC'];
  const html = items.map(name => `
    <span class="scope-tag" style="cursor:pointer" onclick="document.getElementById('lookupInput').value='${name}';lookupItem()">${name}</span>
  `).join('');
  document.getElementById('popularTags').innerHTML = html;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MANUAL TRADES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function logTrade() {
  const item = document.getElementById('trade-item').value.trim();
  const type = document.getElementById('trade-type').value;
  const qty = parseInt(document.getElementById('trade-qty').value);
  const price = parseFloat(document.getElementById('trade-price').value);

  if (!item || !qty || !price) {
    document.getElementById('tradeMsg').innerHTML = '<span style="color:var(--danger)">FILL ALL FIELDS</span>';
    return;
  }

  const trade = { item, type, qty, price, total: qty * price, date: new Date().toISOString(), id: Date.now() };
  state.manualTrades.push(trade);
  localStorage.setItem('eve_manual_trades', JSON.stringify(state.manualTrades));
  document.getElementById('tradeMsg').innerHTML = `<span style="color:var(--accent2)">‚úì LOGGED: ${item} (${type.toUpperCase()}) x${qty} @ ${formatISK(price)}</span>`;

  // Clear form
  ['trade-item','trade-qty','trade-price'].forEach(id => document.getElementById(id).value = '');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  FILTERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let txTypeFilter = 'all';
function filterTransactions(val) { updateTransactionsTable(val, txTypeFilter); }
function filterTxType(val) { txTypeFilter = val; updateTransactionsTable(document.querySelector('#tab-transactions .esi-input').value, val); }

function setTimeRange(days, btn) {
  state.currentTimeRange = days;
  document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  updateProfitChart(days);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  TABS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(id, btn) {
  document.querySelectorAll('.tab-view').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  if (btn) btn.classList.add('active');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MODAL / LOADING
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal() { document.getElementById('authModal').classList.add('show'); }
function closeModal() { document.getElementById('authModal').classList.remove('show'); }
function showLoading() { document.getElementById('loadingOverlay').classList.add('show'); }
function hideLoading() { document.getElementById('loadingOverlay').classList.remove('show'); }

function setConnectedState() {
  document.getElementById('pilotBadge').classList.add('show');
  document.getElementById('pilotName').textContent = state.pilot.name;
  document.getElementById('pilotCorp').textContent = state.pilot.corp;
  const btn = document.getElementById('connectBtn');
  btn.textContent = 'DISCONNECT';
  btn.classList.add('connected');
  btn.onclick = disconnect;
  document.getElementById('refreshBtn').style.display = 'inline-block';
  startAutoRefresh();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  REFRESH
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let autoRefreshInterval = null;
const REFRESH_MS = 5 * 60 * 1000; // 5 minutes

function startAutoRefresh() {
  if (autoRefreshInterval) clearInterval(autoRefreshInterval);
  autoRefreshInterval = setInterval(silentRefresh, REFRESH_MS);
  updateRefreshCountdown();
}

let refreshCountdown = REFRESH_MS / 1000;
let countdownInterval = null;

function updateRefreshCountdown() {
  if (countdownInterval) clearInterval(countdownInterval);
  refreshCountdown = REFRESH_MS / 1000;
  countdownInterval = setInterval(() => {
    refreshCountdown--;
    const btn = document.getElementById('refreshBtn');
    if (refreshCountdown <= 0) {
      refreshCountdown = REFRESH_MS / 1000;
    }
    const mins = Math.floor(refreshCountdown / 60);
    const secs = String(refreshCountdown % 60).padStart(2, '0');
    if (!btn.dataset.loading) btn.textContent = `‚Üª ${mins}:${secs}`;
  }, 1000);
}

async function silentRefresh() {
  if (!state.connected || !state.pilot) return;
  try {
    const { transactions, orders, assets, wallet } = await fetchCharacterData(state.pilot.id);
    state.transactions = mergeAndSaveHistory(transactions);
    state.orders       = orders;
    state.assets       = assets;
    state.wallet       = wallet;
    updateUI();
    updateStorageInfo();
    updateRefreshCountdown();
    showRefreshFlash('AUTO-SYNCED');
  } catch(e) {
    console.warn('Auto-refresh failed:', e);
  }
}

async function manualRefresh() {
  if (!state.connected || !state.pilot) return;
  const btn = document.getElementById('refreshBtn');
  btn.dataset.loading = '1';
  btn.textContent = '‚Üª SYNCING...';
  btn.style.opacity = '0.6';
  try {
    const { transactions, orders, assets, wallet } = await fetchCharacterData(state.pilot.id);
    state.transactions = mergeAndSaveHistory(transactions);
    state.orders       = orders;
    state.assets       = assets;
    state.wallet       = wallet;
    updateUI();
    updateStorageInfo();
    updateRefreshCountdown();
    showRefreshFlash('SYNCED ‚úì');
  } catch(e) {
    showRefreshFlash('SYNC FAILED');
  }
  delete btn.dataset.loading;
  btn.style.opacity = '1';
}

function showRefreshFlash(msg) {
  const ticker = document.getElementById('ticker');
  const prev = ticker.textContent;
  ticker.textContent = msg;
  ticker.style.color = 'var(--accent2)';
  setTimeout(() => { ticker.textContent = prev; ticker.style.color = ''; }, 2000);
}

function disconnect() {
  if (autoRefreshInterval) clearInterval(autoRefreshInterval);
  if (countdownInterval) clearInterval(countdownInterval);
  ['eve_access_token','eve_refresh_token','eve_token_expiry','eve_char_id','eve_char_name','pkce_verifier','pkce_state']
    .forEach(k => localStorage.removeItem(k));
  location.reload();
}


// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  JITA TRACKER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const JITA_REGION  = 10000002;
const JITA_STATION = 60003760;

// Watch list persisted to localStorage
let jitaWatchList = JSON.parse(localStorage.getItem('jita_watchlist') || '[]');
// Cache: typeId -> { buy, sell, history, fetchedAt }
let jitaPriceCache = {};
// Selected item for chart
let jitaSelectedId  = null;
let jitaSelectedRange = 7;
let jitaChart = null;

function saveWatchList() {
  localStorage.setItem('jita_watchlist', JSON.stringify(jitaWatchList));
}

// ‚îÄ‚îÄ Jita fetch ‚îÄ‚îÄ
async function fetchJitaPrice(typeId) {
  const cached = jitaPriceCache[typeId];
  if (cached && Date.now() - cached.fetchedAt < 5 * 60 * 1000) return cached;

  // ESI for live price, A4E for history ‚Äî run in parallel
  const [live, a4eHistory] = await Promise.all([
    fetchLivePrices(typeId),
    queueA4EFetch(() => fetchA4EHistory(typeId,
      new Date(Date.now() - 30 * 86400000).toISOString().split('T')[0],
      new Date().toISOString().split('T')[0]
    ))
  ]);

  const result = {
    typeId,
    buy:         live.buy,
    sell:        live.sell,
    buy_volume:  live.buy_volume,
    sell_volume: live.sell_volume,
    history:     a4eHistory,   // A4E format with separate buy/sell
    fetchedAt:   Date.now()
  };
  jitaPriceCache[typeId] = result;
  return result;
}

// ‚îÄ‚îÄ Search suggestions ‚îÄ‚îÄ
let searchTimeout = null;
async function jitaSearch(val) {
  clearTimeout(searchTimeout);
  const box = document.getElementById('jitaSuggestions');
  if (!val || val.length < 2) { box.style.display = 'none'; return; }
  searchTimeout = setTimeout(async () => {
    try {
      // Use A4E search ‚Äî no rate limit, returns id+name directly
      const res  = await fetch(`${A4E}/search?item=tradables&term=${encodeURIComponent(val)}`, { headers: A4E_UA });
      const data = res.ok ? await res.json() : [];
      const results = (Array.isArray(data) ? data : []).slice(0, 8);
      if (!results.length) { box.style.display = 'none'; return; }
      box.innerHTML = results.map(r => `
        <div onclick="addJitaItem(${r.id},'${r.value.replace(/'/g,"\\'")}');document.getElementById('jitaSuggestions').style.display='none';document.getElementById('jitaSearchInput').value='';"
          style="padding:8px 14px;cursor:pointer;font-size:12px;color:var(--text);border-bottom:1px solid var(--border)"
          onmouseover="this.style.background='var(--panel)'" onmouseout="this.style.background=''">
          ${r.value}
        </div>
      `).join('');
      box.style.display = 'block';
    } catch(e) { box.style.display = 'none'; }
  }, 300);
}

async function addJitaItemByName() {
  const val = document.getElementById('jitaSearchInput').value.trim();
  if (!val) return;
  // Try as type ID first
  const numId = parseInt(val);
  if (!isNaN(numId)) { addJitaItem(numId, 'Type ' + numId); return; }
  // Search
  try {
    const res  = await fetch(`https://esi.evetech.net/latest/search/?categories=inventory_type&search=${encodeURIComponent(val)}&strict=true&language=en`);
    const data = res.ok ? await res.json() : {};
    const ids  = data.inventory_type || [];
    if (!ids.length) {
      // loose search
      const res2  = await fetch(`https://esi.evetech.net/latest/search/?categories=inventory_type&search=${encodeURIComponent(val)}&strict=false&language=en`);
      const data2 = res2.ok ? await res2.json() : {};
      const ids2  = (data2.inventory_type || []).slice(0, 1);
      if (!ids2.length) { alert('Item not found: ' + val); return; }
      const names = await resolveTypeNames(ids2);
      addJitaItem(ids2[0], names[ids2[0]] || val);
    } else {
      const names = await resolveTypeNames([ids[0]]);
      addJitaItem(ids[0], names[ids[0]] || val);
    }
  } catch(e) { alert('Search failed'); }
  document.getElementById('jitaSearchInput').value = '';
  document.getElementById('jitaSuggestions').style.display = 'none';
}

async function addJitaItem(typeId, name) {
  if (jitaWatchList.find(i => i.typeId === typeId)) return; // already watching
  jitaWatchList.push({ typeId, name, addedAt: Date.now() });
  saveWatchList();
  await refreshJitaItem(typeId);
  renderJitaWatchTable();
  updateJitaStats();
}

function removeJitaItem(typeId) {
  jitaWatchList = jitaWatchList.filter(i => i.typeId !== typeId);
  saveWatchList();
  renderJitaWatchTable();
  updateJitaStats();
}

async function refreshJitaItem(typeId) {
  delete jitaPriceCache[typeId]; // force fresh fetch
  await fetchJitaPrice(typeId);
}

async function refreshAllJita() {
  const btn = document.querySelector('[onclick="refreshAllJita()"]');
  if (btn) { btn.textContent = '‚Üª SYNCING...'; btn.style.opacity = '0.6'; }
  await Promise.all(jitaWatchList.map(i => refreshJitaItem(i.typeId)));
  renderJitaWatchTable();
  updateJitaStats();
  document.getElementById('jita-lastsync').textContent = new Date().toLocaleTimeString();
  if (btn) { btn.textContent = '‚Üª SYNC ALL'; btn.style.opacity = '1'; }
}

function renderJitaWatchTable() {
  const tbody = document.getElementById('jitaWatchBody');
  if (!jitaWatchList.length) {
    tbody.innerHTML = '<tr><td colspan="9" class="no-data" style="padding:40px">Add items above to start tracking</td></tr>';
    return;
  }

  // Find avg buy price from transactions
  const myBuyPrices = {};
  state.transactions.filter(t => t.is_buy).forEach(t => {
    if (!myBuyPrices[t.type_id]) myBuyPrices[t.type_id] = [];
    myBuyPrices[t.type_id].push(t.unit_price);
  });

  tbody.innerHTML = jitaWatchList.map(item => {
    const p       = jitaPriceCache[item.typeId] || {};
    const buy     = p.buy  || null;
    const sell    = p.sell || null;
    const spread  = (buy && sell) ? sell - buy : null;
    const margin  = (buy && sell) ? ((sell - buy) / sell * 100) : null;

    // 24h change from history
    const hist    = p.history || [];
    const today   = hist[hist.length - 1];
    const yesterday = hist[hist.length - 2];
    const change  = (today && yesterday && yesterday.average)
      ? ((today.average - yesterday.average) / yesterday.average * 100) : null;

    // My avg buy
    const myBuys  = myBuyPrices[item.typeId];
    const myAvg   = myBuys ? myBuys.reduce((a,b)=>a+b,0)/myBuys.length : null;
    const unreal  = (myAvg && sell) ? sell - myAvg : null;

    const marginColor = margin === null ? '' : margin > 15 ? 'var(--accent2)' : margin > 5 ? 'var(--warn)' : 'var(--danger)';
    const changeColor = change === null ? '' : change > 0 ? 'var(--accent2)' : 'var(--danger)';

    return `<tr style="cursor:pointer" onclick="selectJitaItem(${item.typeId},'${item.name.replace(/'/g,"\\'")}')">
      <td><div class="item-name">${item.name}</div><div class="item-type">ID: ${item.typeId}</div></td>
      <td class="isk-green">${buy  ? formatISK(buy)  + ' ISK' : '‚Äî'}</td>
      <td class="isk-red">${sell ? formatISK(sell) + ' ISK' : '‚Äî'}</td>
      <td class="isk">${spread ? formatISK(spread) : '‚Äî'}</td>
      <td style="color:${marginColor};font-family:Share Tech Mono,monospace;font-size:12px;font-weight:700">${margin !== null ? margin.toFixed(1)+'%' : '‚Äî'}</td>
      <td style="color:${changeColor};font-family:Share Tech Mono,monospace;font-size:12px">${change !== null ? (change>0?'‚ñ≤':'‚ñº')+Math.abs(change).toFixed(2)+'%' : '‚Äî'}</td>
      <td class="isk">${myAvg ? formatISK(myAvg)+' ISK' : '‚Äî'}</td>
      <td style="color:${unreal===null?'':unreal>=0?'var(--accent2)':'var(--danger)'};font-family:Share Tech Mono,monospace;font-size:12px">
        ${unreal !== null ? (unreal>=0?'+':'')+formatISK(unreal)+' ISK' : '‚Äî'}
      </td>
      <td><button onclick="event.stopPropagation();removeJitaItem(${item.typeId})"
        style="background:none;border:1px solid var(--danger);color:var(--danger);padding:2px 8px;cursor:pointer;font-size:10px;font-family:Share Tech Mono,monospace">‚úï</button></td>
    </tr>`;
  }).join('');
}

function updateJitaStats() {
  document.getElementById('jita-watching').textContent = jitaWatchList.length;
}

// ‚îÄ‚îÄ Jita chart ‚îÄ‚îÄ
function initJitaChart() {
  const ctx = document.getElementById('jitaChart').getContext('2d');
  jitaChart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [
      { label: 'SELL', data: [], borderColor: '#ff6b35', borderWidth: 2, pointRadius: 0, tension: 0.3, fill: false },
      { label: 'BUY',  data: [], borderColor: '#00ff9d', borderWidth: 2, pointRadius: 0, tension: 0.3, fill: false }
    ]},
    options: {
      ...chartDefaults,
      plugins: {
        ...chartDefaults.plugins,
        legend: { display: true, labels: { color: '#5a7a95', font: { family: 'Share Tech Mono', size: 9 }, boxWidth: 10, padding: 8 } }
      }
    }
  });
}

function selectJitaItem(typeId, name) {
  jitaSelectedId = typeId;
  document.getElementById('jitaChartLabel').textContent = name;
  renderJitaChart();
}

function setJitaRange(days, btn) {
  jitaSelectedRange = days;
  document.querySelectorAll('#tab-jita .time-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderJitaChart();
}

function renderJitaChart() {
  if (!jitaSelectedId || !jitaChart) return;
  const p    = jitaPriceCache[jitaSelectedId] || {};
  const hist = (p.history || []).slice(-jitaSelectedRange);
  if (!hist.length) return;

  const a4e = isA4EFormat(hist);

  jitaChart.data.labels = hist.map(h => formatDate(a4e ? h.price_date : h.date));

  if (a4e) {
    jitaChart.data.datasets[0].data  = hist.map(h => h.sell_price_avg);
    jitaChart.data.datasets[0].label = 'SELL AVG';
    jitaChart.data.datasets[0].borderColor = '#ff6b35';
    jitaChart.data.datasets[1].data  = hist.map(h => h.buy_price_avg);
    jitaChart.data.datasets[1].label = 'BUY AVG';
    jitaChart.data.datasets[1].borderColor = '#00ff9d';
  } else {
    jitaChart.data.datasets[0].data  = hist.map(h => h.highest);
    jitaChart.data.datasets[0].label = 'HIGH';
    jitaChart.data.datasets[1].data  = hist.map(h => h.lowest);
    jitaChart.data.datasets[1].label = 'LOW';
  }
  jitaChart.update();

  // Stats
  const avgSell = a4e ? hist.reduce((s,h)=>s+(h.sell_price_avg||0),0)/hist.length : 0;
  const avgBuy  = a4e ? hist.reduce((s,h)=>s+(h.buy_price_avg||0),0)/hist.length  : 0;
  const highSell = a4e ? Math.max(...hist.map(h=>h.sell_price_high||0)) : 0;
  const lowBuy   = a4e ? Math.min(...hist.filter(h=>h.buy_price_low>0).map(h=>h.buy_price_low)) : 0;
  const vol = hist.reduce((s,h)=>s+((h.sell_volume_avg||h.volume||0)),0);

  document.getElementById('jitaChartStats').innerHTML = `
    <div><div class="stat-label" style="font-size:9px">AVG SELL</div><div style="font-family:Share Tech Mono,monospace;font-size:12px;color:var(--accent3)">${formatISK(avgSell)}</div></div>
    <div><div class="stat-label" style="font-size:9px">AVG BUY</div><div style="font-family:Share Tech Mono,monospace;font-size:12px;color:var(--accent2)">${formatISK(avgBuy)}</div></div>
    <div><div class="stat-label" style="font-size:9px">SELL HIGH</div><div style="font-family:Share Tech Mono,monospace;font-size:12px;color:var(--warn)">${formatISK(highSell)}</div></div>
    <div><div class="stat-label" style="font-size:9px">DATA SOURCE</div><div style="font-family:Share Tech Mono,monospace;font-size:10px;color:var(--text-dim)">${a4e ? 'ADAM4EVE' : 'ESI'}</div></div>
  `;
}

// ‚îÄ‚îÄ Inventory with Jita prices ‚îÄ‚îÄ
async function updateJitaInventory() {
  if (!state.assets || !state.assets.length) return;
  const tbody = document.getElementById('jitaInventoryBody');
  tbody.innerHTML = '<tr><td colspan="7" class="no-data">FETCHING JITA PRICES...</td></tr>';

  // Fetch prices for all asset type IDs
  const ids = [...new Set(state.assets.map(a => a.type_id))];
  await Promise.all(ids.map(id => fetchJitaPrice(id)));

  tbody.innerHTML = state.assets.map(a => {
    const p      = jitaPriceCache[a.type_id] || {};
    const buy    = p.buy  || null;
    const sell   = p.sell || null;
    const total  = sell ? sell * a.quantity : null;
    const margin = (buy && sell) ? ((sell-buy)/sell*100) : null;
    const signal = margin === null ? '‚Äî' : margin > 15 ? '<span class="status-badge status-sell">SELL</span>' : margin > 5 ? '<span class="status-badge status-hold">HOLD</span>' : '<span class="status-badge status-buy">BUY MORE</span>';

    return `<tr>
      <td><div class="item-name">${a.item_name}</div></td>
      <td><span class="qty-badge">${a.quantity.toLocaleString()}</span></td>
      <td class="isk-green">${buy  ? formatISK(buy)  + ' ISK' : '‚Äî'}</td>
      <td class="isk-red">${sell ? formatISK(sell) + ' ISK' : '‚Äî'}</td>
      <td class="isk">${total ? formatISK(total) : '‚Äî'}</td>
      <td style="font-family:Share Tech Mono,monospace;font-size:12px;color:${margin===null?'var(--text-dim)':margin>15?'var(--accent2)':margin>5?'var(--warn)':'var(--danger)'}">${margin!==null?margin.toFixed(1)+'%':'‚Äî'}</td>
      <td>${signal}</td>
    </tr>`;
  }).join('');
}

// ‚îÄ‚îÄ Auto-populate watch list from transactions on connect ‚îÄ‚îÄ
async function autoPopulateWatchList() {
  if (!state.transactions.length) return;
  // Add top 5 most traded items automatically if watch list is empty
  if (jitaWatchList.length > 0) return;
  const freq = {};
  state.transactions.forEach(t => {
    freq[t.type_id] = freq[t.type_id] || { typeId: t.type_id, name: t.item_name, count: 0 };
    freq[t.type_id].count++;
  });
  const top = Object.values(freq).sort((a,b)=>b.count-a.count).slice(0,5);
  for (const item of top) {
    jitaWatchList.push({ typeId: item.typeId, name: item.name, addedAt: Date.now() });
  }
  saveWatchList();
  await Promise.all(jitaWatchList.map(i => fetchJitaPrice(i.typeId)));
  renderJitaWatchTable();
  updateJitaStats();
  document.getElementById('jita-lastsync').textContent = new Date().toLocaleTimeString();
}

// Hook into existing updateUI to also refresh Jita inventory
const _origUpdateUI = updateUI;
window._coreUpdateUI = _origUpdateUI;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  TRADE HISTORY SNAPSHOT (localStorage)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HISTORY_KEY = 'eve_tx_history';

function loadStoredHistory() {
  try { return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); }
  catch(e) { return []; }
}

function mergeAndSaveHistory(freshTx) {
  const stored = loadStoredHistory();
  const map = {};
  [...stored, ...freshTx].forEach(t => {
    const key = t.transaction_id || (t.date + t.type_id + t.quantity);
    map[key] = t;
  });
  const merged = Object.values(map).sort((a, b) => new Date(b.date) - new Date(a.date));
  try {
    localStorage.setItem(HISTORY_KEY, JSON.stringify(merged));
  } catch(e) {
    // Storage full ‚Äî trim oldest 20% and retry
    const trimmed = merged.slice(0, Math.floor(merged.length * 0.8));
    try { localStorage.setItem(HISTORY_KEY, JSON.stringify(trimmed)); } catch(e2) {}
  }
  return merged;
}

function getStorageUsed() {
  try {
    const raw   = localStorage.getItem(HISTORY_KEY) || '';
    const kb    = (raw.length * 2 / 1024).toFixed(1);
    const count = loadStoredHistory().length;
    return { kb, count };
  } catch(e) { return { kb: 0, count: 0 }; }
}

function updateStorageInfo() {
  const { kb, count } = getStorageUsed();
  const el  = document.getElementById('txStorageUsed');
  const cnt = document.getElementById('txHistoryCount');
  if (el)  el.textContent  = `Storage used: ${kb} KB`;
  if (cnt) cnt.textContent = `(${count.toLocaleString()} stored)`;
}

function clearHistory() {
  if (!confirm('Clear all stored transaction history? This cannot be undone.')) return;
  localStorage.removeItem(HISTORY_KEY);
  updateStorageInfo();
  updateTransactionsTable();
}

function exportCSV() {
  const all = loadStoredHistory();
  if (!all.length) { alert('No transaction history to export.'); return; }
  const headers = ['date','transaction_id','item_name','type_id','is_buy','quantity','unit_price','total','location_name'];
  const rows = all.map(t => headers.map(h => {
    const v = t[h] ?? '';
    return typeof v === 'string' && (v.includes(',') || v.includes('"'))
      ? `"${v.replace(/"/g,'""')}"` : v;
  }).join(','));
  const csv  = [headers.join(','), ...rows].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  const pilot = state.pilot ? state.pilot.name.replace(/\s+/g,'_') : 'pilot';
  a.href     = url;
  a.download = `eve_trades_${pilot}_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CSV IMPORT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function importCSV(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const text = e.target.result;
      const result = parseImportedCSV(text);
      if (!result.rows.length) {
        showImportMsg('No valid rows found. Check the file format.', false);
        return;
      }
      const merged = mergeAndSaveHistory(result.rows);
      state.transactions = merged;
      updateUI();
      updateStorageInfo();
      showImportMsg(
        `‚úì Imported ${result.rows.length} rows (${result.format}) ¬∑ ${result.skipped} skipped ¬∑ ${merged.length.toLocaleString()} total stored`,
        true
      );
    } catch(err) {
      showImportMsg('Import failed: ' + err.message, false);
    }
    // Reset file input so same file can be re-imported
    input.value = '';
  };
  reader.readAsText(file);
}

function showImportMsg(msg, success) {
  const el = document.getElementById('importMsg');
  el.textContent = msg;
  el.style.display = 'block';
  el.style.color = success ? 'var(--accent2)' : 'var(--danger)';
  setTimeout(() => { el.style.display = 'none'; }, 6000);
}

function parseImportedCSV(text) {
  // Detect delimiter
  const delim = text.includes('\t') ? '\t' : ',';

  const lines = text.trim().split('\n').map(l => l.trim()).filter(Boolean);
  if (lines.length < 2) throw new Error('File is empty or has no data rows');

  // Parse header
  const header = parseCSVLine(lines[0], delim).map(h => h.toLowerCase().trim()
    .replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,''));

  // Detect format
  // Our export format:  date, transaction_id, item_name, type_id, is_buy, quantity, unit_price, total
  // EVE in-game format: date, type, item, price, quantity, credit, balance, location, transaction_id
  const isOurFormat  = header.includes('transaction_id') && header.includes('item_name');
  const isEveFormat  = header.includes('item') && header.includes('credit') && header.includes('type');
  const isAdamFormat = header.includes('typeid') || header.includes('type_id');

  let rows = [];
  let skipped = 0;
  let format = 'UNKNOWN';

  if (isOurFormat) {
    format = 'DASHBOARD EXPORT';
    for (let i = 1; i < lines.length; i++) {
      try {
        const cols = parseCSVLine(lines[i], delim);
        const row  = {};
        header.forEach((h, idx) => row[h] = cols[idx] || '');
        if (!row.date || !row.item_name) { skipped++; continue; }
        rows.push({
          transaction_id: row.transaction_id || generateImportId(row),
          date:           row.date,
          item_name:      row.item_name,
          type_id:        parseInt(row.type_id) || 0,
          is_buy:         row.is_buy === 'true' || row.is_buy === '1',
          quantity:       parseInt(row.quantity) || 1,
          unit_price:     parseFloat(row.unit_price) || 0,
          total:          parseFloat(row.total) || 0,
          category:       row.category || 'Imported',
          location_name:  row.location_name || 'Unknown',
          source:         'import'
        });
      } catch(e) { skipped++; }
    }

  } else if (isEveFormat) {
    // EVE in-game wallet journal export
    // Columns: Date, Type, Item, Price, Quantity, Credit, Balance, Location, Transaction ID
    format = 'EVE IN-GAME JOURNAL';
    const idxDate  = header.indexOf('date');
    const idxType  = header.indexOf('type');
    const idxItem  = header.indexOf('item') !== -1 ? header.indexOf('item') : header.findIndex(h => h.includes('item'));
    const idxPrice = header.findIndex(h => h.includes('price'));
    const idxQty   = header.findIndex(h => h.includes('quantity') || h === 'qty');
    const idxCredit= header.findIndex(h => h.includes('credit'));
    const idxLoc   = header.findIndex(h => h.includes('location'));
    const idxTxId  = header.findIndex(h => h.includes('transaction'));

    for (let i = 1; i < lines.length; i++) {
      try {
        const cols     = parseCSVLine(lines[i], delim);
        const itemName = cols[idxItem]  || '';
        const typeStr  = (cols[idxType] || '').toLowerCase();
        const price    = parseFloat((cols[idxPrice] || '0').replace(/[, ]/g,'')) || 0;
        const qty      = parseInt((cols[idxQty]   || '1').replace(/[, ]/g,''))  || 1;
        const credit   = parseFloat((cols[idxCredit]|| '0').replace(/[, ]/g,'')) || 0;
        const isBuy    = typeStr.includes('buy') || credit < 0;
        const date     = cols[idxDate] || new Date().toISOString();
        const txId     = cols[idxTxId] || generateImportId({ date, itemName, qty });
        const loc      = idxLoc >= 0 ? (cols[idxLoc] || 'Unknown') : 'Unknown';

        if (!itemName || !price) { skipped++; continue; }

        rows.push({
          transaction_id: txId,
          date:           normaliseDate(date),
          item_name:      itemName,
          type_id:        0,
          is_buy:         isBuy,
          quantity:       qty,
          unit_price:     price,
          total:          price * qty,
          category:       'Imported',
          location_name:  loc,
          source:         'eve-journal'
        });
      } catch(e) { skipped++; }
    }

  } else {
    // Generic fallback ‚Äî try to map whatever columns exist
    format = 'GENERIC CSV';
    const findCol = (...names) => {
      for (const n of names) {
        const idx = header.findIndex(h => h.includes(n));
        if (idx >= 0) return idx;
      }
      return -1;
    };
    const idxDate  = findCol('date','time','when');
    const idxItem  = findCol('item','name','type','product');
    const idxPrice = findCol('price','unit','cost','value');
    const idxQty   = findCol('qty','quantity','amount','count','vol');
    const idxBuy   = findCol('buy','side','direction','action');

    if (idxItem < 0 || idxPrice < 0) throw new Error('Could not detect item/price columns. Use EVE in-game export or this dashboard\'s CSV export.');

    for (let i = 1; i < lines.length; i++) {
      try {
        const cols  = parseCSVLine(lines[i], delim);
        const item  = cols[idxItem]  || '';
        const price = parseFloat((cols[idxPrice]||'0').replace(/[, ]/g,'')) || 0;
        const qty   = idxQty >= 0 ? parseInt((cols[idxQty]||'1').replace(/[, ]/g,'')) || 1 : 1;
        const buyRaw = idxBuy >= 0 ? (cols[idxBuy]||'').toLowerCase() : '';
        const isBuy  = buyRaw.includes('buy') || buyRaw === '1' || buyRaw === 'true';
        const date   = idxDate >= 0 ? normaliseDate(cols[idxDate]) : new Date().toISOString();

        if (!item || !price) { skipped++; continue; }

        rows.push({
          transaction_id: generateImportId({ date, item, qty, price }),
          date,
          item_name:      item,
          type_id:        0,
          is_buy:         isBuy,
          quantity:       qty,
          unit_price:     price,
          total:          price * qty,
          category:       'Imported',
          location_name:  'Unknown',
          source:         'generic'
        });
      } catch(e) { skipped++; }
    }
  }

  return { rows, skipped, format };
}

// Parse a single CSV line respecting quoted fields
function parseCSVLine(line, delim = ',') {
  const result = [];
  let cur = '', inQuote = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      if (inQuote && line[i+1] === '"') { cur += '"'; i++; }
      else inQuote = !inQuote;
    } else if (ch === delim && !inQuote) {
      result.push(cur.trim()); cur = '';
    } else {
      cur += ch;
    }
  }
  result.push(cur.trim());
  return result;
}

function normaliseDate(str) {
  // Try to parse various date formats into ISO
  if (!str) return new Date().toISOString();
  // Already ISO
  if (/^\d{4}-\d{2}-\d{2}/.test(str)) return new Date(str).toISOString();
  // DD/MM/YYYY or MM/DD/YYYY
  const parts = str.split(/[\/\-\.]/);
  if (parts.length >= 3) {
    // Assume DD/MM/YYYY for EVE (European format)
    const [d, m, y] = parts;
    const dt = new Date(`${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`);
    if (!isNaN(dt)) return dt.toISOString();
  }
  return new Date(str).toISOString();
}

function generateImportId(obj) {
  // Deterministic ID from row content so re-importing same file doesn't duplicate
  const str = JSON.stringify(obj);
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = ((hash << 5) - hash) + str.charCodeAt(i);
    hash |= 0;
  }
  return 'imp_' + Math.abs(hash);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showStep(n, btn) {
  document.querySelectorAll('.setup-step').forEach(s => s.style.display = 'none');
  document.getElementById('step' + n).style.display = 'block';
  document.querySelectorAll('#setupTabs .nav-tab').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
}

function saveClientId() {
  const id = document.getElementById('clientIdInput').value.trim();
  if (!id) { alert('Please enter your Client ID'); return; }
  localStorage.setItem('eve_client_id', id);
  document.getElementById('savedClientId').textContent = id.slice(0, 8) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
  showStep(3, document.querySelectorAll('#setupTabs .nav-tab')[2]);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', async () => {
  initCharts();
  initJitaChart();
  initPopularItems();

  // Load persisted watch list
  if (jitaWatchList.length) {
    updateJitaStats();
    Promise.all(jitaWatchList.map(i => fetchJitaPrice(i.typeId))).then(() => {
      renderJitaWatchTable();
      document.getElementById('jita-lastsync').textContent = new Date().toLocaleTimeString();
    });
  }

  // Show storage info
  updateStorageInfo();

  // Fill in this page's URL for the callback setup step
  document.getElementById('thisUrl').textContent = location.origin + location.pathname;

  // Restore saved client id display
  const savedId = localStorage.getItem('eve_client_id');
  if (savedId) {
    document.getElementById('savedClientId').textContent = savedId.slice(0, 8) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
  }

  // Live ticker
  const tickers = ['ESI LIVE', 'JITA: ONLINE', 'AMARR: ONLINE', 'DODIXIE: ONLINE'];
  let ti = 0;
  setInterval(() => {
    ti = (ti + 1) % tickers.length;
    document.getElementById('ticker').textContent = tickers[ti];
  }, 3000);

  // Try restoring existing session, otherwise open modal
  const restored = await tryRestoreSession();
  if (!restored) {
    // Skip to right step based on saved state
    const hasClientId = !!localStorage.getItem('eve_client_id');
    setTimeout(() => {
      openModal();
      if (hasClientId) showStep(3, document.querySelectorAll('#setupTabs .nav-tab')[2]);
    }, 500);
  }
});
</script>
</body>
</html>
